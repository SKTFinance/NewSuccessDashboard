<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKT Success Dashboard</title>
    
    <!-- PWA Manifest & Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#002147">

    <!-- Tailwind CSS CDN für schnelle und responsive Stile -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome für Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Definieren der benutzerdefinierten Farben von SKT Finance für Tailwind */
        :root {
            --color-skt-blue: #002147;
            --color-skt-blue-light: #043C64;
            --color-skt-grey-light: #f5f5f5;
            --color-skt-grey-medium: #c7c7c7;
            --color-skt-blue-main: #38bdf8;
            --color-accent-green: #27ae60;
            --color-accent-red: #FF6347;
            --color-accent-red-light: #fecaca; /* UPDATE für dunkleres Rot */
            --color-accent-yellow: #f1c40f;
            --color-accent-gold: #d4af37;
            --color-accent-gold-light: #fff3cd; 
            --color-accent-purple: #8e44ad;
        }

        .bg-skt-blue { background-color: var(--color-skt-blue); }
        .bg-skt-blue-light { background-color: var(--color-skt-blue-light); }
        .bg-skt-grey-light { background-color: var(--color-skt-grey-light); }
        .bg-skt-grey-medium { background-color: var(--color-skt-grey-medium); }
        .text-skt-blue { color: var(--color-skt-blue); }
        .text-skt-blue-light { color: var(--color-skt-blue-light); }
        .text-skt-blue-main { color: var(--color-skt-blue-main); }
        .border-skt-blue-main { border-color: var(--color-skt-blue-main); }

        /* Neue Akzentfarben */
        .text-skt-green-accent { color: var(--color-accent-green); }
        .bg-skt-green-accent { background-color: var(--color-accent-green); }
        .text-skt-red-accent { color: var(--color-accent-red); }
        .bg-skt-red-accent { background-color: var(--color-accent-red); }
        .bg-accent-red-light { background-color: var(--color-accent-red-light); } /* NEU */
        .text-skt-yellow-accent { color: var(--color-accent-yellow); }
        .bg-skt-yellow-accent { background-color: var(--color-accent-yellow); }
        .bg-skt-blue-accent { background-color: var(--color-skt-blue-main); }
        .text-gold { color: var(--color-accent-gold); }
        .bg-accent-purple { background-color: var(--color-accent-purple); }
        .border-accent-purple { border-color: var(--color-accent-purple); }
        .bg-accent-gold { background-color: var(--color-accent-gold); }
        .border-accent-gold { border-color: var(--color-accent-gold); }
        .bg-accent-gold-light { background-color: var(--color-accent-gold-light); }
        .border-skt-blue-accent { border-color: var(--color-skt-blue-main); }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-skt-grey-light);
        }
        
        html.modal-open, body.modal-open {
            overflow: hidden;
        }

        .font-times-new-roman {
            font-family: "Times New Roman", Times, serif;
        }
        
        .progress-circle { transform: rotate(-90deg); }
        .progress-circle .bg-circle { fill: none; stroke: var(--color-skt-grey-medium); stroke-width: 10; }
        .progress-circle .progress-arc { fill: none; stroke: var(--color-accent-green); stroke-width: 10; transition: stroke-dashoffset 0.7s ease-out; stroke-linecap: round; }

        .progress-circle-monthly { transform: rotate(-90deg); }
        .progress-circle-monthly .bg-circle { fill: none; stroke: #e2e8f0; stroke-width: 8; }
        .progress-circle-monthly .progress-arc-eh { fill: none; stroke: var(--color-accent-green); stroke-width: 8; transition: stroke-dashoffset 0.7s ease-out; stroke-linecap: round; }
        .progress-circle-monthly .prognosis-bg-circle { fill: none; stroke: #e2e8f0; stroke-width: 4; }
        .progress-circle-monthly .prognosis-arc-eh { fill: none; stroke: var(--color-accent-yellow); stroke-width: 4; transition: stroke-dashoffset 0.7s ease-out; stroke-linecap: round; }
        #segment-dividers-eh line { stroke: var(--color-skt-grey-light); stroke-width: 2; }

        .tier-card { background-color: white; border-radius: 12px; padding: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 2px solid transparent; }
        .tier-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2); }
        .tier-card.active { border: 2px solid var(--color-accent-green); }
        
        .employee-slot { width: 20px; height: 20px; background-color: var(--color-skt-grey-medium); border-radius: 50%; transition: background-color 0.3s ease-out; border: 1px solid var(--color-skt-grey-medium); }
        .employee-slot.filled { background-color: var(--color-accent-green); }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0; /* Standard: nach rechts ausklappen (für Mobile) */
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 50;
            width: 200px;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: translateY(-10px);
            opacity: 0;
            pointer-events: none;
        }
        .dropdown-menu.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .dropdown-menu a {
            display: flex;
            align-items: center;
        }
        
        .week-divider { position: absolute; height: calc(100% + 0.25rem); top: -0.125rem; width: 2px; background-color: #e2e8f0; z-index: 10; }
        .start-end-divider { position: absolute; height: calc(100% + 0.25rem); top: -0.125rem; width: 2px; background-color: #e2e8f0; z-index: 10; }
        .centered-date-label { position: absolute; bottom: -1.25rem; text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--color-skt-blue-light); white-space: nowrap; z-index: 30; }

        .loader { border: 5px solid var(--color-skt-grey-light); border-top: 5px solid var(--color-skt-blue-main); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        [data-tooltip] { position: relative; cursor: help; }
        [data-tooltip]::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-8px); background-color: var(--color-skt-blue); color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; z-index: 100; }
        [data-tooltip]:hover::after { opacity: 1; visibility: visible; }

        .team-member-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; padding-top: 0; padding-bottom: 0; }
        .team-member-details.open { max-height: 500px; padding-top: 1rem; padding-bottom: 1rem; }
        .details-grid { border-top: 1px solid #e2e8f0; margin-top: 1rem; padding-top: 1rem; }
        .chevron-icon { transition: transform 0.3s ease-in-out; }
        .open .chevron-icon { transform: rotate(180deg); }

        .team-progress-circle { transform: rotate(-90deg); }
        .team-progress-circle .bg-circle { fill: none; stroke: #e2e8f0; stroke-width: 8; }
        .team-progress-circle .progress-arc { 
            fill: none; 
            stroke-width: 8; 
            transition: stroke-dashoffset 0.7s ease-out, stroke 0.5s ease; 
            stroke-linecap: round; 
        }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::before { content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 0.5rem; transition: transform 0.3s ease-in-out; }
        details[open] > summary::before { transform: rotate(180deg); }

        /* Stile für den Ansicht-Umschalter */
        .view-toggle button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid transparent;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .view-toggle button.active {
            background-color: var(--color-skt-blue);
            color: white;
            border-color: var(--color-skt-blue);
        }
        .view-toggle button:not(.active) {
            background-color: var(--color-skt-grey-light);
            color: var(--color-skt-blue-light);
        }
        
        /* Blur-Effekt für neue Mitarbeiter */
        .blurred-section-overlay {
            position: relative;
        }
        .blurred-section-overlay::after {
            content: 'Wird ab 1 EH freigeschaltet';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(245, 245, 245, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-skt-blue);
            font-weight: bold;
            font-size: 1.25rem;
            text-align: center;
            z-index: 10;
            border-radius: 1rem; /* Passt zum Radius des Elternelements */
        }


        /* --- STILE FÜR NEUESTE EINARBEITUNGS-TIMELINE --- */
        .timeline-vertical-line {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: #e2e8f0;
            border-radius: 2px;
            z-index: 1;
        }
        .timeline-vertical-line-progress {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 0;
            width: 4px;
            background-color: var(--color-accent-green);
            border-radius: 2px;
            z-index: 2;
            height: 0%;
            transition: height 0.8s ease-out;
        }
        .timeline-date-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
        }
        .timeline-date-marker {
            position: absolute;
            right: calc(50% + 10px);
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-skt-blue-light);
            white-space: nowrap;
            background-color: var(--color-skt-grey-light);
            padding: 0 4px;
        }
        .timeline-date-marker::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 2px;
            background-color: #94a3b8;
        }

        .timeline-item {
            opacity: 0;
            animation: slideIn 0.5s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* UPDATE: Eingerückte Aufgaben vs. nicht eingerückte Meilensteine */
        .timeline-item-major {
            display: flex;
            align-items: center;
            gap: 1rem; 
            position: relative;
        }
        .timeline-item-major::before {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: -2.25rem;
            width: 0.75rem;
            height: 2px;
            background-color: #cbd5e1;
            z-index: 3;
        }
        .timeline-item-major.completed::before,
        .timeline-item-major.due::before {
            background-color: var(--color-accent-green);
        }
        
        .timeline-item-minor {
            margin-left: 1.5rem; /* Indent minor items */
            padding-left: 1rem;
            border-left: 2px dotted #cbd5e1;
        }

        .timeline-content {
            background-color: #f8fafc;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            width: 100%;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .timeline-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-color: #cbd5e1;
        }
        .timeline-item.completed.seminar .timeline-content,
        .timeline-item.completed.other .timeline-content {
            background-color: #f0fdf4;
        }
        
        .timeline-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .timeline-icon-inline {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background-color: var(--color-skt-grey-medium);
            color: white;
            border: 4px solid var(--color-skt-grey-light);
        }
        .timeline-item.timeline-item-major .timeline-icon-inline {
            position: relative;
            z-index: 5;
            left: -2.25rem;
            margin-right: -1.5rem;
        }
        .timeline-item.completed.seminar .timeline-icon-inline,
        .timeline-item.completed.other .timeline-icon-inline { 
            background-color: var(--color-accent-green); 
        }

        /* NEUE STILE FÜR SPEZIFISCHE ERLEDIGTE AUFGABEN */
        .timeline-item.completed.gespraech .timeline-icon-inline { background-color: var(--color-accent-purple); }
        .timeline-item.completed.gespraech .timeline-content { background-color: #f3e8f7; }
        .timeline-item.completed.meilenstein .timeline-icon-inline { background-color: var(--color-accent-gold); }
        .timeline-item.completed.meilenstein .timeline-content { background-color: #fef9e7; }
        .timeline-item.completed.hausuebung .timeline-icon-inline { background-color: var(--color-skt-blue-main); }
        .timeline-item.completed.hausuebung .timeline-content { background-color: #e0f2fe; }

        .timeline-item.due.seminar .timeline-icon-inline { background-color: var(--color-accent-green); }
        .timeline-item.due.meilenstein .timeline-icon-inline { background-color: var(--color-accent-gold); }
        .timeline-item.due.gespraech .timeline-icon-inline { background-color: var(--color-accent-purple); }
        .timeline-item.due.hausuebung .timeline-icon-inline { background-color: var(--color-skt-blue-main); }

        /* NEU: Goldener Rahmen für Meilensteine */
        .timeline-item.due.meilenstein .timeline-content,
        .timeline-item.completed.meilenstein .timeline-content {
             border: 2px solid var(--color-accent-gold);
        }

        /* NEU: Geblurrter Zustand für Aufbauseminar */
        .aufbauseminar-blurred {
             filter: blur(4px);
             pointer-events: none;
             user-select: none;
             opacity: 0.6;
             transition: all 0.3s ease-in-out;
        }

        /* NEU: Stil für überfällige Aufgaben */
        .overdue-task {
            background-color: #ffefef !important; /* Helles Rot */
            border-color: var(--color-accent-red) !important;
        }
        .overdue-task .timeline-title {
            color: var(--color-accent-red) !important;
        }

        .timeline-info .timeline-title {
            font-weight: 600;
            color: var(--color-skt-blue);
            word-break: break-word;
        }
        .timeline-info .timeline-duedate {
            font-size: 0.875rem;
            color: var(--color-skt-blue-light);
        }
        /* Stile für das iOS-Anleitungs-Modal und Hinweis-Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* NEU: Dropdown-Menü auf größeren Bildschirmen anders ausrichten */
        @media (min-width: 640px) { /* Tailwind 'sm' breakpoint */
            .dropdown-menu {
                left: auto;
                right: 0; /* Auf Desktops nach links ausklappen */
            }
        }

        @media (min-width: 768px) {
            .timeline-item-major::before {
                left: -3.5rem;
                width: 1.5rem;
            }
            .timeline-item-minor {
                margin-left: 3rem;
                padding-left: 2rem;
            }
            .timeline-item.timeline-item-major .timeline-icon-inline {
                left: -3.5rem;
                margin-right: -2.5rem;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-skt-blue">
    <!-- Pull-to-Refresh Indikator -->
    <div id="refresh-indicator" class="fixed top-0 left-0 right-0 flex justify-center pt-3 opacity-0 transition-opacity duration-300 z-40">
        <div class="bg-white rounded-full shadow-lg h-10 w-10 flex items-center justify-center">
            <i class="fas fa-sync-alt text-skt-blue transition-transform duration-200"></i>
        </div>
    </div>

    <!-- Auswahlbereich für Benutzer -->
    <div id="user-select-screen" class="hidden flex-col items-center justify-start min-h-screen bg-gray-100 p-4 pt-16 sm:pt-24">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-xl border border-gray-200 text-center transform transition-transform duration-300 hover:scale-105">
            <div class="mb-6">
                <h1 class="text-3xl font-extrabold text-skt-blue leading-tight">Willkommen zurück!</h1>
                <p class="text-gray-500 mt-2">Wähle deinen Namen, um fortzufahren.</p>
            </div>
            <div class="mb-6">
                <div class="relative">
                    <select id="user-dropdown-select" class="block w-full px-4 py-3 rounded-xl border-2 border-gray-300 bg-white text-lg text-gray-700 appearance-none transition-colors duration-200 focus:border-skt-blue-main focus:ring-2 focus:ring-skt-blue-main focus:outline-none pr-10 cursor-pointer">
                        <option value="">Benutzer wählen ...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </div>
                </div>
            </div>
            <div id="password-container" class="hidden mb-6">
                <input type="password" id="password-input" placeholder="Passwort" class="block w-full px-4 py-3 rounded-xl border-2 border-gray-300 bg-white text-lg text-gray-700 transition-colors duration-200 focus:border-skt-blue-main focus:ring-2 focus:ring-skt-blue-main focus:outline-none">
            </div>
            <button id="start-dashboard-btn" class="hidden w-full bg-skt-blue text-white font-semibold py-3 rounded-xl hover:bg-skt-blue-light transition-colors duration-200 shadow-md transform hover:-translate-y-0.5 active:translate-y-0 text-lg">Dashboard laden</button>
            <p id="user-select-error" class="text-red-600 mt-4 h-5 text-sm"></p>
        </div>
    </div>

    <!-- Dashboard-Container -->
    <div id="dashboard-content" class="hidden flex-col min-h-screen">
        <header class="w-full p-6 md:p-8 bg-skt-blue relative rounded-b-3xl z-50">
            <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-x-8 gap-y-4 relative">
                <div class="flex flex-col">
                    <h1 class="text-4xl sm:text-5xl font-bold font-times-new-roman text-white mb-2" id="welcome-header">Willkommen,</h1>
                    <p id="user-position" class="text-lg text-gold font-bold"></p>
                    <p class="text-lg sm:text-xl text-white mt-2">Dein persönliches Dashboard für Erfolg und Karriereplanung.</p>
                </div>
                <div class="relative self-start sm:self-center flex items-center space-x-2">
                    <button id="back-button" class="hidden bg-skt-blue-light text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-skt-blue-main transition-colors h-10 w-10 flex items-center justify-center" title="Zurück">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button id="einarbeitung-btn" class="bg-skt-blue-light text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-skt-blue-main transition-colors h-10 w-10 flex items-center justify-center" title="Meine Einarbeitung">
                        <i class="fas fa-graduation-cap"></i>
                    </button>
                    <!-- NEU: KI Assistent Button -->
                    <button id="ai-assistant-btn" class="bg-accent-purple text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition-colors h-10 w-10 flex items-center justify-center" title="KI-Assistent">
                        <i class="fas fa-robot"></i>
                    </button>
                    <div class="relative">
                        <button id="settings-btn" class="bg-skt-blue-light text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-skt-blue-main transition-colors h-10 w-10 flex items-center justify-center" title="Einstellungen">
                            <i class="fas fa-cog"></i>
                        </button>
                        <div id="settings-menu" class="dropdown-menu hidden">
                             <a href="#" id="superuser-btn" class="hidden block px-4 py-2 text-sm text-skt-blue hover:bg-skt-grey-light"><i class="fas fa-users-cog w-5 mr-2"></i>Gesamtansicht</a>
                             <a href="#" id="money-view-btn" class="block px-4 py-2 text-sm text-skt-blue hover:bg-skt-grey-light"><i class="fas fa-euro-sign w-5 mr-2"></i>Geld-Ansicht</a>
                             <a href="#" id="edit-user-btn" class="block px-4 py-2 text-sm text-skt-blue hover:bg-skt-grey-light"><i class="fas fa-user-edit w-5 mr-2"></i>Personendaten</a>
                             <a href="#" id="clear-cache-btn" class="block px-4 py-2 text-sm text-skt-blue hover:bg-skt-grey-light"><i class="fas fa-sync-alt w-5 mr-2"></i>Cache leeren</a>
                             <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-skt-blue hover:bg-skt-grey-light"><i class="fas fa-right-from-bracket w-5 mr-2"></i>Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Hauptansicht für Dashboard -->
        <main id="main-dashboard-view" class="flex flex-col w-full max-w-7xl mx-auto flex-grow px-6 md:px-8 pt-2 md:pt-4 pb-6 space-y-6 overflow-hidden">
            <div id="notification-prompt" class="hidden bg-skt-blue-light text-white p-4 rounded-lg shadow-md flex justify-between items-center">
                <p>Möchtest du über wichtige Updates benachrichtigt werden?</p>
                <button id="enable-notifications-btn" class="bg-white text-skt-blue font-bold py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">Aktivieren</button>
            </div>

            <div id="status-message" class="flex flex-col items-center justify-center text-center text-lg font-semibold text-skt-blue mt-6">
                <div class="loader mb-4"></div><p id="status-text">Daten werden geladen...</p>
            </div>

            <div id="dashboard-sections" class="space-y-12 opacity-0 transition-opacity duration-500">
                <section id="monthly-planning-view" class="bg-white rounded-2xl p-6 md:p-8 shadow-lg">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
                        <h2 id="monthly-planning-title" class="text-2xl font-semibold text-skt-blue">Monatsplanung</h2>
                        <div id="planning-view-toggle" class="view-toggle hidden flex w-full sm:w-auto space-x-2">
                            <button id="struktur-view-btn" class="flex-1">Struktur</button>
                            <button id="team-view-btn" class="active flex-1">Gruppe</button>
                            <button id="personal-view-btn" class="flex-1">Persönlich</button>
                        </div>
                    </div>
                    <div class="mb-8"><div id="weekly-progress-container" class="w-full flex relative h-5 mb-4 items-end"></div></div>
                    <div class="flex flex-col md:flex-row items-center justify-between gap-8 mb-8">
                        <div class="flex-grow md:w-1/2 relative w-full h-auto max-w-sm max-h-sm">
                            <svg class="progress-circle-monthly w-full h-full" viewBox="0 0 100 100">
                                <circle class="bg-circle" cx="50" cy="50" r="45"></circle>
                                <circle class="progress-arc-eh" cx="50" cy="50" r="45" id="progress-circle-eh"></circle>
                                
                                <circle class="prognosis-bg-circle" cx="50" cy="50" r="35"></circle>
                                <circle class="prognosis-arc-eh" cx="50" cy="50" r="35" id="prognosis-circle-eh"></circle>

                                <g id="segment-dividers-eh"></g>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center flex-col text-center">
                                <p class="text-xl sm:text-2xl lg:text-3xl font-bold text-skt-green-accent">
                                    <span id="eh-center-current">0</span> / <span id="eh-center-goal">0</span>
                                </p>
                                <p id="eh-center-unit-label" class="text-sm text-gray-500">Einheiten erreicht</p>
                                <p class="text-lg font-bold text-skt-yellow-accent mt-2">
                                    <span id="eh-soll-value">0</span>
                                </p>
                                <p id="eh-soll-unit-label" class="text-xs text-gray-500">Soll Einheiten</p>
                            </div>
                        </div>
                        <div class="flex-grow md:w-1/2 flex flex-col gap-8 w-full justify-center">
                            <div class="p-4 bg-skt-grey-light rounded-xl shadow-md text-center">
                                <p class="text-sm font-semibold text-skt-blue mb-2">Analysetermine</p>
                                <p class="text-lg font-bold text-skt-blue" id="appointments-text">0 / 0 / 0</p>
                                <p class="text-xs mb-2">
                                    <span class="font-semibold" style="color: var(--color-accent-green);">Gehalten</span> / 
                                    <span class="font-semibold" style="color: var(--color-skt-blue-main);">Vereinbart</span> / 
                                    <span class="font-semibold" style="color: var(--color-accent-red);">Soll</span>
                                </p>
                                <div id="appointments-progress-bar" class="w-full bg-accent-red-light h-3 rounded-full overflow-hidden relative">
                                    <div id="appointments-vereinbart-bar" class="h-full bg-skt-blue-accent absolute top-0 left-0 transition-all duration-700 ease-out" style="width: 0%;"></div>
                                    <div id="appointments-gehalten-bar" class="h-full bg-skt-green-accent absolute top-0 left-0 transition-all duration-700 ease-out" style="width: 0%;"></div>
                                </div>
                            </div>
                            <!-- UPDATE: Bewerbungsgespräche mit Balken -->
                            <div class="p-4 bg-accent-gold-light rounded-xl shadow-md border-2 border-accent-gold text-center">
                                <p class="text-sm text-skt-blue-light font-bold mb-2" data-tooltip="Fortschritt deiner gehaltenen Bewerbungsgespräche.">Einstellungstermine</p>
                                <p class="text-xl font-bold text-skt-blue mb-4"><span id="et-current">0</span> / <span id="et-goal">0</span></p>
                                <div id="interviews-progress-wrapper" class="w-full bg-skt-grey-medium h-3 rounded-full overflow-hidden relative">
                                    <div id="interviews-progress-bar" class="h-full bg-skt-green-accent absolute top-0 left-0 transition-all duration-700 ease-out" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="employee-view" class="bg-white rounded-2xl p-6 md:p-8 shadow-lg">
                    <h2 class="text-2xl font-semibold text-skt-blue mb-6 text-center">Dein aktueller Fortschritt</h2>
                    
                    <!-- NEU: Einarbeitungs-Banner -->
                    <div id="einarbeitung-banner" class="hidden mb-6 p-4 bg-skt-blue-light text-white rounded-xl shadow-lg flex justify-between items-center cursor-pointer hover:bg-skt-blue transition-colors">
                        <div>
                            <p class="font-bold text-lg">Neuer Mitarbeiter? Starte hier!</p>
                            <p>Verfolge deine Einarbeitungsschritte und starte erfolgreich durch.</p>
                        </div>
                        <i class="fas fa-arrow-right text-2xl"></i>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div id="tier-1-card" class="tier-card active"><h3 class="text-2xl font-bold mb-2 text-skt-blue">T1</h3><p class="text-sm text-skt-blue-light mb-4">0 EH</p><div class="w-full bg-skt-grey-light h-2 rounded-full overflow-hidden"><div id="tier-1-progress" class="h-full bg-skt-green-accent transition-all duration-700 ease-out" style="width: 100%;"></div></div></div>
                        <div id="tier-2-card" class="tier-card"><h3 class="text-2xl font-bold mb-2 text-skt-blue">T2</h3><p class="text-sm text-skt-blue-light mb-4">1.250 EH</p><div class="w-full bg-skt-grey-light h-2 rounded-full overflow-hidden"><div id="tier-2-progress" class="h-full bg-skt-green-accent transition-all duration-700 ease-out" style="width: 0%;"></div></div></div>
                        <div id="tier-3-card" class="tier-card"><h3 class="text-2xl font-bold mb-2 text-skt-blue">T3</h3><p class="text-sm text-skt-blue-light mb-4">2.500 EH</p><div class="w-full bg-skt-grey-light h-2 rounded-full overflow-hidden"><div id="tier-3-progress" class="h-full bg-skt-green-accent transition-all duration-700 ease-out" style="width: 0%;"></div></div></div>
                        <div id="tier-gst-card" class="tier-card"><h3 class="text-2xl font-bold mb-2 text-skt-blue">Junior GST</h3><p class="text-sm text-skt-blue-light mb-4">4.000 EH</p><div class="w-full bg-skt-grey-light h-2 rounded-full overflow-hidden"><div id="tier-gst-progress" class="h-full bg-skt-green-accent transition-all duration-700 ease-out" style="width: 0%;"></div></div></div>
                    </div>
                    <div class="flex flex-col md:flex-row items-center justify-between gap-8 mt-8">
                        <div class="flex-grow md:w-1/2 relative w-full h-auto max-w-96 max-h-96">
                            <svg class="progress-circle w-full h-full" viewBox="0 0 100 100">
                                <circle class="bg-circle" cx="50" cy="50" r="40"></circle><circle class="progress-arc" cx="50" cy="50" r="40" id="progress-circle-career"></circle>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center flex-col text-center">
                                <p id="career-progress-percentage" class="text-3xl sm:text-4xl lg:text-5xl font-bold text-skt-blue">0%</p><p class="text-sm text-skt-blue-light mt-1" id="progress-to-next-text">Fortschritt zum ...</p>
                            </div>
                        </div>
                        <div class="flex-grow md:w-1/2 grid grid-cols-2 gap-4 w-full">
                            <div class="p-4 bg-skt-grey-light rounded-xl shadow-md flex flex-col items-center justify-center text-center">
                                <p id="eh-value-title" class="text-xs text-skt-blue-light font-bold" data-tooltip="Deine gesamten erreichten Einheiten">Erreichte EH (insgesamt)</p>
                                <div class="flex items-center justify-center h-full">
                                    <p id="eh-value-display" class="text-2xl font-bold text-skt-blue mt-1"><span id="current-eh-display">0</span><span id="eh-value-unit"> EH</span></p><i id="eh-checkmark" class="fas fa-check-circle text-5xl text-green-500 hidden"></i>
                                </div>
                            </div>
                            <div class="p-4 bg-skt-grey-light rounded-xl shadow-md flex flex-col items-center justify-center text-center">
                                <p class="text-xs text-skt-blue-light font-bold">Nächstes Karriereziel</p>
                                <div id="employee-info-container" class="mt-1 flex flex-col items-center justify-center">
                                    <p class="text-2xl font-bold text-skt-blue" id="employee-count-display">0</p><p id="employee-goal-status" class="text-skt-blue-light text-sm mt-1">...</p>
                                </div>
                                <div id="employee-slots-container" class="flex space-x-2 mt-2"></div>
                            </div>
                            <div class="p-4 col-span-2 bg-skt-grey-light rounded-xl shadow-md flex flex-col items-center justify-center text-center">
                                <p id="next-milestone" class="text-skt-blue-light text-sm font-bold">Nächster Meilenstein: <span class="text-skt-blue font-semibold">...</span></p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="leadership-view" class="hidden bg-white rounded-2xl p-6 md:p-8 shadow-lg">
                    <div id="leader-personal-goal-container" class="mb-8"></div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 id="leadership-view-title" class="text-2xl font-semibold text-skt-blue">Deine Struktur-Übersicht</h2>
                        <div id="leadership-view-mode-toggle" class="view-toggle flex space-x-2">
                            <button id="grid-view-btn" title="Kachelansicht"><i class="fas fa-th-large"></i></button>
                            <button id="list-view-btn" class="active" title="Listenansicht"><i class="fas fa-bars"></i></button>
                        </div>
                    </div>
                    <p id="leadership-view-count" class="text-center sm:text-left text-skt-blue-light mb-8"></p>
                    <div id="team-members-container" class="mt-6"></div>
                    <div id="passive-members-section" class="mt-8"></div>
                </section>
            </div>          
        </main>

        <!-- NEU: Ansicht für Einarbeitung -->
    <main id="einarbeitung-view" class="hidden w-full max-w-7xl mx-auto flex-grow px-4 md:px-8 pt-6 pb-6">
         <div class="bg-white rounded-2xl p-6 md:p-8 shadow-lg">
              <h2 id="einarbeitung-title" class="text-3xl font-bold text-skt-blue mb-8 text-center">Dein Einarbeitungsplan</h2>
              
              <!-- Container für die Trainee-Ansicht -->
              <div id="trainee-onboarding-view">
                  <div id="onboarding-progress-container" class="mb-8 px-2 md:px-4">
                      <div class="flex justify-between items-center mb-1">
                          <p class="font-semibold text-skt-blue">Gesamtfortschritt</p>
                          <p id="onboarding-progress-text" class="font-bold text-skt-blue">0%</p>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner relative">
                          <div id="onboarding-soll-bar" class="bg-red-300 h-4 rounded-full absolute top-0 left-0 transition-all duration-700 ease-out" style="width: 0%; z-index: 1;" data-tooltip="Soll-Fortschritt"></div>
                          <div id="onboarding-progress-bar" class="bg-skt-green-accent h-4 rounded-full absolute top-0 left-0 transition-all duration-700 ease-out" style="width: 0%; z-index: 2;" data-tooltip="Ist-Fortschritt"></div>
                      </div>
                  </div>

                      <div class="space-y-8">
                      <!-- Container Grundseminar -->
                      <div id="grundseminar-container" class="bg-skt-grey-light p-6 rounded-xl shadow-md">
                          <h3 class="text-2xl font-bold text-skt-blue mb-6 text-center">Grundseminar</h3>
                          <div class="timeline-wrapper flex gap-x-4 md:gap-x-6">
                              <div class="w-12 md:w-20 flex-shrink-0 relative pt-4 pb-4">
                                  <div class="timeline-vertical-line"></div>
                                  <div class="timeline-vertical-line-progress" id="grundseminar-progress"></div>
                                  <div class="timeline-date-markers" id="grundseminar-date-markers"></div>
                              </div>
                              <div id="grundseminar-steps-container" class="space-y-4 flex-grow"></div>
                          </div>
                  </div>
                      <!-- Container Aufbauseminar -->
                      <div id="aufbauseminar-container" class="bg-skt-grey-light p-6 rounded-xl shadow-md">
                          <h3 class="text-2xl font-bold text-skt-blue mb-6 text-center">Aufbauseminar</h3>
                          <div class="timeline-wrapper flex gap-x-4 md:gap-x-6">
                              <div class="w-12 md:w-20 flex-shrink-0 relative pt-4 pb-4">
                                  <div class="timeline-vertical-line"></div>
                                  <div class="timeline-vertical-line-progress" id="aufbauseminar-progress"></div>
                                  <div class="timeline-date-markers" id="aufbauseminar-date-markers"></div>
                              </div>
                              <div id="aufbauseminar-steps-container" class="space-y-4 flex-grow"></div>
                            </div>
                      </div>
                    </div>
                </div>

                <!-- Container für die Führungskraft-Ansicht -->
                <div id="leader-onboarding-view" class="hidden">
                    <!-- Inhalt wird per JS generiert -->
                </div>

            </div>
    </main>
    </div>

    <!-- Modals -->
    <div id="ios-instructions-modal" class="modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-sm text-center">
            <h3 class="text-xl font-bold text-skt-blue mb-2">Benachrichtigungen aktivieren</h3>
            <p class="text-gray-600 mb-4">Um Benachrichtigungen auf einem iPhone zu erhalten, füge diese App bitte zuerst zu deinem Home-Bildschirm hinzu:</p>
            <ol class="text-left text-gray-600 space-y-2 mb-4">
                <li>1. Tippe auf das <i class="fas fa-share-square"></i> **Teilen-Symbol** in der Browser-Leiste.</li>
                <li>2. Scrolle nach unten und wähle **"Zum Home-Bildschirm"**.</li>
                <li>3. Starte die App vom neuen Icon auf deinem Home-Bildschirm.</li>
            </ol>
            <button id="close-ios-modal-btn" class="w-full bg-skt-blue text-white font-semibold py-2 rounded-lg hover:bg-skt-blue-light transition-colors">Verstanden</button>
        </div>
    </div>
    
    <div id="hinweis-modal" class="modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-md relative">
            <button id="close-hinweis-modal-btn" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-skt-blue">&times;</button>
            <h3 id="hinweis-modal-title" class="text-xl font-bold text-skt-blue mb-4">Hinweis</h3>
            <div id="hinweis-modal-content" class="text-gray-700"></div>
        </div>
    </div>

    <!-- NEU: Modal zum Bearbeiten von Benutzerdaten -->
    <div id="edit-user-modal" class="modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-lg w-full relative">
             <button id="cancel-edit-user-btn" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-skt-blue">&times;</button>
             <h3 class="text-2xl font-bold text-skt-blue mb-6">Personendaten bearbeiten</h3>
             <form id="edit-user-form" class="space-y-4">
                 <div>
                     <label for="edit-name" class="block text-sm font-medium text-gray-700">Name</label>
                     <input type="text" id="edit-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-skt-blue-main focus:border-skt-blue-main">
                 </div>
                 <div>
                     <label for="edit-pwd" class="block text-sm font-medium text-gray-700">Passwort</label>
                     <input type="text" id="edit-pwd" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-skt-blue-main focus:border-skt-blue-main">
                 </div>
                  <div>
                     <label for="edit-eh-quote" class="block text-sm font-medium text-gray-700">EH pro AT Quote</label>
                     <input type="number" id="edit-eh-quote" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-skt-blue-main focus:border-skt-blue-main">
                 </div>
                 <div>
                     <label for="edit-status" class="block text-sm font-medium text-gray-700">Status</label>
                     <select id="edit-status" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-skt-blue-main focus:border-skt-blue-main"></select>
                 </div>
                 <div>
                     <label for="edit-position" class="block text-sm font-medium text-gray-700">Karrierestufe</label>
                     <select id="edit-position" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-skt-blue-main focus:border-skt-blue-main"></select>
                 </div>
                 <div class="pt-4 flex justify-end space-x-3">
                     <button type="button" id="cancel-edit-user-btn-2" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300 transition-colors">Abbrechen</button>
                     <button type="submit" id="save-user-btn" class="bg-skt-blue text-white font-semibold py-2 px-5 rounded-lg hover:bg-skt-blue-light transition-colors">Speichern</button>
                 </div>
             </form>
        </div>
    </div>


    <script type="module">
        // --- KONSTANTEN ---
        const SEATABLE_API_TOKEN = "b148f4c735d193f77841ce4e4ddb2bb8bc2e446b";
        const SEATABLE_APP_ACCESS_TOKEN_URL = "https://cloud.seatable.io/api/v2.1/dtable/app-access-token/";
        const SEATABLE_DTABLE_UUID = "5b374b51-789c-4aac-a12f-02574f8f4855";
        // Cache-Konstanten: Ändere die Version, um alle Caches zu invalidieren.
        const CACHE_VERSION = 'v1.1'; 
        const CACHE_PREFIX = `skt-dashboard-cache-${CACHE_VERSION}-`;
        
        let COLUMN_MAPS = {}; // Wird dynamisch gefüllt

        // --- GLOBALE VARIABLEN ---
        let seaTableAccessToken = null;
        let apiGatewayUrl = null; 
        let METADATA = {}; 
        let db = {
            mitarbeiter: [],
            karriereplan: [],
            einarbeitungsschritte: [],
            umsatz: [],
            termine: [],
            monatsplanung: [],
            einarbeitung: [],
        };

        let personalData = {};
        let teamData = {};
        let structureData = {};
        let loggedInUserData = {};
        let viewHistory = [];
        
        let currentPlanningView = 'team';
        let currentLeadershipViewMode = 'list';
        let isSuperuserView = false;
        let isMoneyView = false;
        let currentView = 'dashboard';
        let HIERARCHY_CACHE = null;
        let currentOnboardingSubView = 'leader-list';
        
        // --- DOM-ELEMENTE ---
        const dom = {
            welcomeHeader: document.getElementById('welcome-header'),
            userPosition: document.getElementById('user-position'),
            statusMessage: document.getElementById('status-message'),
            statusText: document.getElementById('status-text'),
            dashboardSections: document.getElementById('dashboard-sections'),
            employeeView: document.getElementById('employee-view'),
            leadershipView: document.getElementById('leadership-view'),
            teamMembersContainer: document.getElementById('team-members-container'),
            passiveMembersSection: document.getElementById('passive-members-section'),
            leadershipViewTitle: document.getElementById('leadership-view-title'),
            leadershipViewCount: document.getElementById('leadership-view-count'),
            leadershipViewModeToggle: document.getElementById('leadership-view-mode-toggle'),
            fortschrittKreisKarriere: document.getElementById('progress-circle-career'),
            careerProgressPercentage: document.getElementById('career-progress-percentage'),
            progressToNextText: document.getElementById('progress-to-next-text'),
            currentEhDisplay: document.getElementById('current-eh-display'),
            nextMilestone: document.getElementById('next-milestone'),
            weeklyProgressContainer: document.getElementById('weekly-progress-container'),
            ehProgressCircle: document.getElementById('progress-circle-eh'),
            prognosisCircleEh: document.getElementById('prognosis-circle-eh'),
            segmentDividersEh: document.getElementById('segment-dividers-eh'),
            ehCenterCurrent: document.getElementById('eh-center-current'),
            ehCenterGoal: document.getElementById('eh-center-goal'),
            ehSollValue: document.getElementById('eh-soll-value'),
            etCurrentDisplay: document.getElementById('et-current'),
            etGoalDisplay: document.getElementById('et-goal'),
            appointmentsText: document.getElementById('appointments-text'),
            appointmentsVereinbartBar: document.getElementById('appointments-vereinbart-bar'),
            appointmentsGehaltenBar: document.getElementById('appointments-gehalten-bar'),
            employeeCountDisplay: document.getElementById('employee-count-display'),
            employeeSlotsContainer: document.getElementById('employee-slots-container'),
            employeeGoalStatus: document.getElementById('employee-goal-status'),
            interviewsProgressBar: document.getElementById('interviews-progress-bar'),
            userDropdownSelect: document.getElementById('user-dropdown-select'),
            userSelectError: document.getElementById('user-select-error'),
            tierCards: [
                document.getElementById('tier-1-card'),
                document.getElementById('tier-2-card'),
                document.getElementById('tier-3-card'),
                document.getElementById('tier-gst-card')
            ],
            tierProgressBars: [
                document.getElementById('tier-1-progress'),
                document.getElementById('tier-2-progress'),
                document.getElementById('tier-3-progress'),
                document.getElementById('tier-gst-progress')
            ],
            settingsBtn: document.getElementById('settings-btn'),
            settingsMenu: document.getElementById('settings-menu'),
            logoutBtn: document.getElementById('logout-btn'),
            clearCacheBtn: document.getElementById('clear-cache-btn'),
            superuserBtn: document.getElementById('superuser-btn'),
            backButton: document.getElementById('back-button'),
            moneyViewBtn: document.getElementById('money-view-btn'),
            monthlyPlanningTitle: document.getElementById('monthly-planning-title'),
            monthlyPlanningView: document.getElementById('monthly-planning-view'),
            planningViewToggle: document.getElementById('planning-view-toggle'),
            teamViewBtn: document.getElementById('team-view-btn'),
            personalViewBtn: document.getElementById('personal-view-btn'),
            strukturViewBtn: document.getElementById('struktur-view-btn'),
            gridViewBtn: document.getElementById('grid-view-btn'),
            listViewBtn: document.getElementById('list-view-btn'),
            mainDashboardView: document.getElementById('main-dashboard-view'),
            einarbeitungView: document.getElementById('einarbeitung-view'),
            einarbeitungBtn: document.getElementById('einarbeitung-btn'),
            einarbeitungBanner: document.getElementById('einarbeitung-banner'),
            einarbeitungTitle: document.getElementById('einarbeitung-title'),
            traineeOnboardingView: document.getElementById('trainee-onboarding-view'),
            leaderOnboardingView: document.getElementById('leader-onboarding-view'),
            grundseminarStepsContainer: document.getElementById('grundseminar-steps-container'),
            aufbauseminarStepsContainer: document.getElementById('aufbauseminar-steps-container'),
            grundseminarProgress: document.getElementById('grundseminar-progress'),
            aufbauseminarProgress: document.getElementById('aufbauseminar-progress'),
            grundseminarDateMarkers: document.getElementById('grundseminar-date-markers'),
            aufbauseminarDateMarkers: document.getElementById('aufbauseminar-date-markers'),
            hinweisModal: document.getElementById('hinweis-modal'),
            hinweisModalTitle: document.getElementById('hinweis-modal-title'),
            hinweisModalContent: document.getElementById('hinweis-modal-content'),
            closeHinweisModalBtn: document.getElementById('close-hinweis-modal-btn'),
            closeIosModalBtn: document.getElementById('close-ios-modal-btn'),
            iosInstructionsModal: document.getElementById('ios-instructions-modal'),
            aiAssistantBtn: document.getElementById('ai-assistant-btn'),
            leaderPersonalGoalContainer: document.getElementById('leader-personal-goal-container'),
            editUserBtn: document.getElementById('edit-user-btn'),
            editUserModal: document.getElementById('edit-user-modal'),
            editUserForm: document.getElementById('edit-user-form'),
            cancelEditUserBtn: document.getElementById('cancel-edit-user-btn'),
            cancelEditUserBtn2: document.getElementById('cancel-edit-user-btn-2'),
            saveUserBtn: document.getElementById('save-user-btn'),
        };

        // --- SEATABLE API FUNKTIONEN ---

        async function getSeaTableAccessToken() {
            try {
                const url = `${SEATABLE_APP_ACCESS_TOKEN_URL}?dtable_uuid=${SEATABLE_DTABLE_UUID}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Authorization': `Token ${SEATABLE_API_TOKEN}` }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                seaTableAccessToken = data.access_token;
                apiGatewayUrl = data.dtable_server;
jet                // console.log("SeaTable App Access Token and API Gateway URL obtained.");
            } catch (error) {
                console.error("Error getting SeaTable access token:", error);
                setStatus("Fehler bei der Verbindung zur Datenbank.", true);
            }
        }
        
        async function fetchColumnMaps() {
            if (!seaTableAccessToken || !apiGatewayUrl) {
                console.error("Cannot fetch column maps without access token and gateway URL.");
                return {};
            }
            try {
                const url = `${apiGatewayUrl}api/v2/dtables/${SEATABLE_DTABLE_UUID}/metadata/`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${seaTableAccessToken}` }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const newColumnMaps = {};
                if (data && data.metadata && data.metadata.tables) {
                    METADATA.tables = data.metadata.tables;
                    data.metadata.tables.forEach(table => {
                        const tableNameLower = table.name.toLowerCase();
                        newColumnMaps[tableNameLower] = {};
                        table.columns.forEach(col => {
                            newColumnMaps[tableNameLower][col.name] = col.key;
                        });
                    });
                }
                // console.log("Dynamically fetched column maps:", newColumnMaps);
                return newColumnMaps;
            } catch (error) {
                console.error("Error fetching column maps:", error);
                setStatus("Fehler beim Laden der Datenbankstruktur.", true);
                return {};
            }
        }

        async function seaTableSqlQuery(sql, convertLinks = true) {
            let retries = 5;
            let wait = 2000; // Start with a 2-second wait
            while (retries > 0) {
                if (!seaTableAccessToken || !apiGatewayUrl) {
                    console.error("Cannot run SQL query without access token and gateway URL.");
                    return [];
                }
                try {
                    const url = `${apiGatewayUrl}api/v2/dtables/${SEATABLE_DTABLE_UUID}/sql/`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${seaTableAccessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sql, convert_link_id: convertLinks })
                    });
                    if (response.status === 429) throw new Error('RateLimit');
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error_message || JSON.stringify(errorData)}`);
                    }
                    const data = await response.json();
                    return data.results || [];
                } catch (error) {
                    if (error.message === 'RateLimit') {
                        retries--;
                        if (retries === 0) {
                            console.error(`SQL query failed after multiple retries due to rate limiting: ${sql}`);
                            setStatus(`API-Limit erreicht. Daten konnten nicht geladen werden.`, true);
                            return [];
                        }
                        console.warn(`SQL query rate limited. Retrying in ${wait}ms...`);
                        await delay(wait);
                        wait *= 2;
                    } else {
                        console.error("Error executing SeaTable SQL query:", error);
                        setStatus(`Fehler bei der SQL-Abfrage.`, true);
                        return [];
                    }
                }
            }
            return [];
        }

        async function seaTableQuery(tableName) {
            let retries = 5;
            let wait = 2000; // Start with a 2-second wait
            while (retries > 0) {
                if (!seaTableAccessToken || !apiGatewayUrl) {
                    console.error("Cannot fetch table without access token and gateway URL.");
                    return [];
                }
                try {
                    let allRows = [];
                    let start = 0;
                    const limit = 1000;
                    let hasMore = true;

                    while(hasMore) {
                        const url = `${apiGatewayUrl}api/v2/dtables/${SEATABLE_DTABLE_UUID}/rows/?table_name=${encodeURIComponent(tableName)}&start=${start}&limit=${limit}&convert_link_id=true`;
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${seaTableAccessToken}` }
                        });
                        if (response.status === 429) throw new Error('RateLimit');
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const data = await response.json();
                        allRows = allRows.concat(data.rows);
                        hasMore = data.rows.length >= limit;
                        start += limit;
                    }
                    return allRows;
                } catch (error) {
                    if (error.message === 'RateLimit') {
                        retries--;
                        if (retries <= 0) {
                             console.error(`Failed to fetch table ${tableName} after multiple retries due to rate limiting.`);
                             setStatus(`API-Limit erreicht. Daten konnten nicht geladen werden.`, true);
                             return [];
                        }
                        console.warn(`Rate limit hit for ${tableName}. Retrying in ${wait}ms...`);
                        await delay(wait);
                        wait *= 2;
                    } else {
                        console.error(`Error fetching data from table ${tableName}:`, error);
                        setStatus(`Fehler beim Laden der Tabelle: ${tableName}.`, true);
                        return [];
                    }
                }
            }
            return [];
        }
        
        async function seaTableUpdateRow(tableName, rowId, rowData) {
            if (!seaTableAccessToken || !apiGatewayUrl) return false;
            try {
                const url = `${apiGatewayUrl}api/v2/dtables/${SEATABLE_DTABLE_UUID}/rows/`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${seaTableAccessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_name: tableName, row_id: rowId, row: rowData })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error_message}`);
                }
                return true;
            } catch (error) {
                console.error(`Error updating row in table ${tableName}:`, error);
                setStatus(`Fehler beim Speichern der Daten in Tabelle: ${tableName}.`, true);
                return false;
            }
        }

        // --- DATA NORMALIZATION & MAPPING ---
        function normalizeAllData() {
            const tableNames = Object.keys(db).filter(name => COLUMN_MAPS[name]);

            for (const tableName of tableNames) {
                const tableMeta = METADATA.tables.find(t => t.name.toLowerCase() === tableName);
                if (!tableMeta) continue;

                if (Array.isArray(db[tableName])) {
                    db[tableName] = db[tableName].map(row => {
                        const newRow = { ...row };
                        for (const colName in COLUMN_MAPS[tableName]) {
                            const colKey = COLUMN_MAPS[tableName][colName];
                            const colMeta = tableMeta.columns.find(c => c.key === colKey);
                            let value = row[colKey];

                            if (value !== undefined && value !== null) {
                                // Intelligente Normalisierung basierend auf Spaltentyp
                                if (colMeta && colMeta.type === 'link') {
                                    let id = null, displayValue = null;
                                    if (Array.isArray(value) && value.length > 0 && value[0]) {
                                        id = value[0].row_id;
                                        displayValue = value[0].display_value;
                                    } else if (typeof value === 'object' && !Array.isArray(value) && value && value.row_id) {
                                        id = value.row_id;
                                        displayValue = value.display_value;
                                    }

                                    if (colName === 'Karrierestufe') {
                                        value = displayValue;
                                    } else { // Default für Links wie Werber
                                        value = id;
                                    }
                                } else if (colMeta && colMeta.type === 'single-select') {
                                    const option = colMeta.data.options.find(opt => opt.id === value);
                                    value = option ? option.name : value;
                                } else if (colMeta && (colMeta.type === 'link-formula' || colMeta.type === 'lookup') && Array.isArray(value) && value.length > 0 && typeof value[0] === 'object' && value[0] !== null) {
                                    value = value[0].display_value;
                                }
                            }
                            newRow[colName] = value;
                        }
                        return newRow;
                    });
                }
            }
        }
        
        function mapSqlResults(results, tableName) {
            const tableNameLower = tableName.toLowerCase();
            if (!COLUMN_MAPS[tableNameLower]) return results;
            // KORREKTUR: tableMeta muss hier im Scope definiert werden, um auf die Metadaten zugreifen zu können.
            const tableMeta = METADATA.tables.find(t => t.name.toLowerCase() === tableNameLower);
            const reversedMap = Object.entries(COLUMN_MAPS[tableNameLower]).reduce((acc, [name, key]) => {
                acc[key] = name;
                return acc;
            }, {});
            
            return results.map(row => {
                const newRow = {};
                for (const key in row) {
                    const name = reversedMap[key] || key;
                    let value = row[key];

                    // KORREKTUR: Konvertiert Single-Select-IDs (z.B. für Status) in Text-Werte
                    // Diese Logik war vorher fehlerhaft, da tableMeta nicht im Scope war.
                    if (tableMeta) {
                        const colMeta = tableMeta.columns.find(c => c.key === key);
                        if (colMeta && colMeta.type === 'single-select' && value !== null) {
                            const option = colMeta.data.options.find(opt => opt.id === value);
                            value = option ? option.name : value;
                        }
                    }
                    newRow[name] = value;
                }
                return newRow;
            });
        }

        async function loadAllData() {
            HIERARCHY_CACHE = null; // Hierarchie-Cache bei jedem Neuladen invalidieren
            setStatus("Lade Datenbank-Zugang...");
            await getSeaTableAccessToken();
            if (!seaTableAccessToken) return false;

            // Lade Spalten-Mappings aus Cache oder API
            let cachedColumnMaps = loadFromCache('column_maps', 60);
            if (cachedColumnMaps) {
                // console.log("Lade Spalten-Mappings aus dem Cache.");
                COLUMN_MAPS = cachedColumnMaps.maps;
                METADATA.tables = cachedColumnMaps.meta;
            } else {
                // console.log("Lade Spalten-Mappings von der API.");
                COLUMN_MAPS = await fetchColumnMaps();
                if (Object.keys(COLUMN_MAPS).length === 0) return false;
                saveToCache('column_maps', { maps: COLUMN_MAPS, meta: METADATA.tables });
            }

            setStatus("Lade Stammdaten...");
            const tablesToLoad = ['Mitarbeiter', 'Karriereplan', 'Einarbeitungsschritte'];
            
            for (const tableName of tablesToLoad) {
                const key = tableName.toLowerCase();
                let cachedData = loadFromCache(key, 60); // Cache für 60 Minuten

                if (cachedData) {
                    // console.log(`Lade '${tableName}' aus dem Cache.`);
                    db[key] = cachedData;
                } else {
                    // console.log(`Lade '${tableName}' von der API.`);
                    const apiData = await seaTableQuery(tableName);
                    if (apiData && apiData.length > 0) {
                        db[key] = apiData;
                        saveToCache(key, apiData);
                    } else {
                        // Wenn die API-Abfrage (trotz Retries) fehlschlägt, ist das kritisch.
                        if (tableName === 'Mitarbeiter') {
                            setStatus(`Kritischer Fehler: Mitarbeiterdaten konnten nicht geladen werden.`, true);
                            return false; // Stoppe die Initialisierung
                        }
                        console.error(`Konnte '${tableName}' nicht von der API laden.`);
                    }
                }
            }

            normalizeAllData();
            // console.log("Stammdaten geladen und zwischengespeichert.");
            return true;
        }

        // --- HILFSFUNKTIONEN ---
        function saveToCache(key, data) {
            try {
                const item = {
                    timestamp: new Date().getTime(),
                    data: data
                };
                localStorage.setItem(CACHE_PREFIX + key, JSON.stringify(item));
            } catch (e) {
                console.error("Fehler beim Speichern im Cache", e);
            }
        }

        function loadFromCache(key, maxAgeMinutes = 60) {
            try {
                const itemStr = localStorage.getItem(CACHE_PREFIX + key);
                if (!itemStr) return null;
                const item = JSON.parse(itemStr);
                const now = new Date().getTime();
                if (now - item.timestamp > maxAgeMinutes * 60 * 1000) return null;
                return item.data;
            } catch (e) {
                return null;
            }
        }

        const delay = ms => new Promise(res => setTimeout(res, ms));

        function setStatus(msg, isError = false) {
            dom.statusText.textContent = msg;
            dom.statusMessage.style.color = isError ? 'var(--color-accent-red)' : '';
            dom.statusMessage.style.display = msg ? 'flex' : 'none';
            const loader = dom.statusMessage.querySelector('.loader');
            if (loader) loader.style.display = isError ? 'none' : 'block';
        }

        function clearChildren(el) { while (el.firstChild) el.removeChild(el.firstChild); }
        function findRowById(tableName, id) { return db[tableName.toLowerCase()].find(row => row._id === id); }
        
        function escapeSql(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/'/g, "''");
        }
        
        function getMonthlyCycleDates() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const findCycleStartForMonth = (year, month) => {
                const date = new Date(year, month, 1);
                while (date.getDay() !== 4) { date.setDate(date.getDate() + 1); }
                if (date.getDate() <= 2) { date.setDate(date.getDate() + 7); }
                return date;
            };

            let currentMonth = today.getMonth();
            let currentYear = today.getFullYear();
            let thisMonthCycleStart = findCycleStartForMonth(currentYear, currentMonth);
            let startDate, endDate;

            if (today < thisMonthCycleStart) {
                let prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                let prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                startDate = findCycleStartForMonth(prevYear, prevMonth);
                endDate = new Date(thisMonthCycleStart);
                endDate.setDate(endDate.getDate() - 1);
            } else {
                let nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
                let nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;
                startDate = thisMonthCycleStart;
                let nextMonthCycleStart = findCycleStartForMonth(nextYear, nextMonth);
                endDate = new Date(nextMonthCycleStart);
                endDate.setDate(endDate.getDate() - 1);
            }
            endDate.setHours(23, 59, 59, 999);
            return { startDate, endDate };
        }
        function animateValue(element, start, end, duration, formatAsCurrency = false) {
            if (!element) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (end - start) + start);
                element.textContent = formatAsCurrency 
                    ? value.toLocaleString('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 })
                    : value.toLocaleString('de-DE');
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
        function updateCircleProgress(circleElement, radius, percentage) {
            if (!circleElement) return;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (Math.min(percentage, 100) / 100) * circumference;
            circleElement.style.strokeDasharray = `${circumference} ${circumference}`;
            circleElement.style.strokeDashoffset = offset;
        }

        // --- DATENBERECHNUNGS-LOGIK (UMGESTELLT AUF SQL) ---

        /*
         * HINWEIS ZUM AUFBAU DER 'TERMINE' DATENBANK:
         * Es gibt 2 wichtige Spalten: `Kategorie` und `Status`.
         *
         * KATEGORIEN:
         * - AT: Analysetermin (erster Schritt)
         * - BT: Beratungstermin (folgt auf AT)
         * - ST: Servicetermin (folgt auf BT)
         * - ET: Einstellungstermin
         *
         * STATUS-LOGIK FÜR ZÄHLUNG:
         *
         * AT (Analysetermin):
         * - Gehalten: Status ist 'Gehalten'.
         * - Ausgemacht: Status ist 'Ausgemacht' ODER 'Gehalten'.
         *
         * ET (Einstellungstermin):
         * - Gehalten: Status ist 'Gehalten', 'Weiterer ET', 'Info Eingeladen', 'Info Bestätigt', 'Info Anwesend', 'Wird Mitarbeiter'.
         * - Ausgemacht: Status ist 'Ausgemacht' ODER einer der 'Gehalten'-Stati.
         *   (Wird aktuell nicht separat in den KPIs ausgewiesen, aber die Logik ist so definiert).
         */

        async function fetchBulkDashboardData(mitarbeiterIds) {
            if (!mitarbeiterIds || mitarbeiterIds.length === 0) return [];

            const users = mitarbeiterIds.map(id => findRowById('mitarbeiter', id)).filter(Boolean);
            if (users.length === 0) return [];

            const { startDate, endDate } = getMonthlyCycleDates();
            const startDateIso = startDate.toISOString().split('T')[0];
            const endDateIso = endDate.toISOString().split('T')[0];
            const currentMonthName = startDate.toLocaleString('de-DE', { month: 'long' });
            const currentYear = startDate.getFullYear();

            // Die Abfragen holen jetzt Daten für den gesamten Zeitraum, die Filterung nach Benutzern erfolgt im Code per ID.
            // Das ist robuster als das Filtern nach Namen in der SQL-Abfrage.
            const planQuery = `SELECT \`Mitarbeiter_ID\`, \`EH_Ziel\`, \`ET_Ziel\` FROM \`Monatsplanung\` WHERE \`Monat\` = '${currentMonthName}' AND \`Jahr\` = ${currentYear}`;
            const ehQuery = `SELECT \`Mitarbeiter_ID\`, SUM(\`EH\`) AS \`ehIst\` FROM \`Umsatz\` WHERE \`Datum\` >= '${startDateIso}' AND \`Datum\` <= '${endDateIso}' GROUP BY \`Mitarbeiter_ID\``;
            const termineQuery = `SELECT \`Mitarbeiter_ID\`, \`Kategorie\`, \`Status\` FROM \`Termine\` WHERE \`Datum\` >= '${startDateIso}' AND \`Datum\` <= '${endDateIso}'`;
            const totalEhQuery = `SELECT \`Mitarbeiter_ID\`, SUM(\`EH\`) AS \`totalEh\` FROM \`Umsatz\` GROUP BY \`Mitarbeiter_ID\``;

            // WICHTIG: convertLinks wird auf `false` gesetzt, um die stabilen Row-IDs statt der Namen zu erhalten.
            const [planResultRaw, ehResultRaw, termineResultRaw, totalEhResultRaw] = await Promise.all([
                seaTableSqlQuery(planQuery, false),
                seaTableSqlQuery(ehQuery, false),
                seaTableSqlQuery(termineQuery, false),
                seaTableSqlQuery(totalEhQuery, false)
            ]);
            
            const planResults = mapSqlResults(planResultRaw, 'Monatsplanung');
            const ehResults = mapSqlResults(ehResultRaw, 'Umsatz');
            const termineResults = mapSqlResults(termineResultRaw, 'Termine');
            const totalEhResults = mapSqlResults(totalEhResultRaw, 'Umsatz');

            const AT_STATUS_GEHALTEN = ['Gehalten'];
            const AT_STATUS_AUSGEMACHT = ['Ausgemacht', 'Gehalten'];
            const ET_STATUS_GEHALTEN = ['Gehalten', 'Weiterer ET', 'Info Eingeladen', 'Info Bestätigt', 'Info Anwesend', 'Wird Mitarbeiter'];

            return users.map(user => {
                // KORREKTUR: Die ID befindet sich in der `row_id` Eigenschaft des ersten Objekts im Array.
                const plan = planResults.find(p => p.Mitarbeiter_ID && Array.isArray(p.Mitarbeiter_ID) && p.Mitarbeiter_ID[0] && p.Mitarbeiter_ID[0].row_id === user._id) || {};
                const eh = ehResults.find(e => e.Mitarbeiter_ID && Array.isArray(e.Mitarbeiter_ID) && e.Mitarbeiter_ID[0] && e.Mitarbeiter_ID[0].row_id === user._id) || {};
                const totalEh = totalEhResults.find(te => te.Mitarbeiter_ID && Array.isArray(te.Mitarbeiter_ID) && te.Mitarbeiter_ID[0] && te.Mitarbeiter_ID[0].row_id === user._id) || {};
                const userTermine = termineResults.filter(t => t.Mitarbeiter_ID && Array.isArray(t.Mitarbeiter_ID) && t.Mitarbeiter_ID[0] && t.Mitarbeiter_ID[0].row_id === user._id);

                let atIst = 0, atVereinbart = 0, etIst = 0;
                userTermine.forEach(t => {
                    if (t.Kategorie === 'AT') { if (AT_STATUS_GEHALTEN.includes(t.Status)) atIst++; if (AT_STATUS_AUSGEMACHT.includes(t.Status)) atVereinbart++; } 
                    else if (t.Kategorie === 'ET') { if (ET_STATUS_GEHALTEN.includes(t.Status)) etIst++; }
                });

                const ehZiel = plan['EH_Ziel'] || 0, etZiel = plan['ET_Ziel'] || 0, ehIst = eh.ehIst || 0;
                const atSoll = (user.EHproATQuote && ehZiel > 0) ? Math.round(ehZiel / user.EHproATQuote) : 0;
                const totalCurrentEh = totalEh.totalEh || 0;
                const anzahlGeworbenerMA = db.mitarbeiter.filter(m => m.Werber === user._id).length;
                const position = user.Karrierestufe || "";

                return { id: user._id, name: user.Name, position, ehGoal: ehZiel, ehCurrent: ehIst, etGoal: etZiel, etCurrent: etIst, atGoal: atSoll, atCurrent: atIst, atVereinbart, totalCurrentEh, recruitedEmployees: anzahlGeworbenerMA, isTrainee: position.toLowerCase().includes('trainee') || (position.toLowerCase().includes('ga') && position.length < 5), isLeader: !position.toLowerCase().includes('trainee') && (!position.toLowerCase().includes('ga') || position.length >= 5) };
            });
        }

        async function fetchDashboardDataWithSql(mitarbeiterId) {
            const results = await fetchBulkDashboardData([mitarbeiterId]);
            return results[0] || {};
        }

        function isUserLeader(user) {
            if (!user || !user.Karrierestufe) return false;
            const pos = user.Karrierestufe.toLowerCase();
            // Eine Führungskraft ist jeder, der kein 'Trainee' in der Karrierestufe hat.
            return !pos.includes('trainee');
        }

       function buildHierarchy() {
            if (HIERARCHY_CACHE) return HIERARCHY_CACHE;

            const hierarchy = {};
            const nameToIdMap = {};
            const allUsers = db.mitarbeiter;

            allUsers.forEach(u => {
                if (u._id) {
                    hierarchy[u._id] = { user: u, children: [] };
                    if (u.Name) nameToIdMap[u.Name] = u._id;
                }
            });

            allUsers.forEach(u => {
                const userName = u.Name || 'Unbekannt';
                const werberValue = u.Werber; // Benutze die normalisierte 'Werber' Eigenschaft

                if (!werberValue) return; // Mitarbeiter hat keinen Werber

                let managerId = null;

                if (hierarchy[werberValue]) { // Fall 1: Werber ist eine gültige _id
                    managerId = werberValue;
                } else if (nameToIdMap[werberValue]) { // Fall 2: Werber ist ein Name (als Fallback)
                    managerId = nameToIdMap[werberValue];
                }

                if (managerId && hierarchy[managerId]) {
                    hierarchy[managerId].children.push(u._id);
                }
            });

            HIERARCHY_CACHE = hierarchy;
            return hierarchy;
        }

       function getSubordinates(leaderId, type) { // 'gruppe' or 'struktur'
            const leader = findRowById('mitarbeiter', leaderId);
            if (!leader) return [];

            const hierarchy = buildHierarchy();
            const subordinates = [];

            if (type === 'gruppe') {
                const queue = [...(hierarchy[leaderId]?.children || [])];
                const visited = new Set(queue);
                while (queue.length > 0) {
                    const currentId = queue.shift();
                    const user = findRowById('mitarbeiter', currentId);
                    if (!user) continue;

                    if (!isUserLeader(user)) { // Ist ein Trainee
                        subordinates.push(user);
                        const node = hierarchy[currentId];
                        if (node) {
                            node.children.forEach(childId => {
                                if (!visited.has(childId)) {
                                    queue.push(childId);
                                    visited.add(childId);
                                }
                            });
                        }
                    }
                    // Wenn es eine Führungskraft ist, wird der Pfad hier nicht weiter verfolgt.
                }
            } else if (type === 'struktur') {
                const leaderHierarchyLevel = db.karriereplan.find(k => k.Stufe === leader.Karrierestufe)?.Hierarchie || 99;
                const queue = [...(hierarchy[leaderId]?.children || [])];
                const visited = new Set(queue);

                while (queue.length > 0) {
                    const currentId = queue.shift();
                    const user = findRowById('mitarbeiter', currentId);
                    if (!user) continue;

                    // Nur Führungskräfte für die Strukturansicht berücksichtigen
                    if (isUserLeader(user)) {
                        const userHierarchyLevel = db.karriereplan.find(k => k.Stufe === user.Karrierestufe)?.Hierarchie || 0;

                        // Füge den Benutzer hinzu, wenn seine Hierarchiestufe strikt niedriger ist als die des Betrachters.
                        // Dies behandelt den "Gleichstand"-Fall (z.B. GST unter GST).
                        if (userHierarchyLevel < leaderHierarchyLevel) {
                            subordinates.push(user);
                        }
                    }
                    
                    // Immer die gesamte Struktur durchlaufen, um alle relevanten Führungskräfte in der Downline zu finden,
                    // auch wenn der aktuelle Benutzer nicht hinzugefügt wurde.
                    const node = hierarchy[currentId];
                    if (node) {
                        node.children.forEach(childId => {
                            if (!visited.has(childId)) {
                                queue.push(childId);
                                visited.add(childId);
                            }
                        });
                    }
                }
            }

            return subordinates;
        }
        
        function getAllSubordinatesRecursive(leaderId) {
            const hierarchy = buildHierarchy();
            const subordinates = [];
            const queue = [...(hierarchy[leaderId]?.children || [])];
            const visited = new Set(queue);

            while (queue.length > 0) {
                const currentId = queue.shift();
                const current = hierarchy[currentId];
                if (!current) continue;
                
                subordinates.push(current.user);
                current.children.forEach(childId => { if (!visited.has(childId)) { queue.push(childId); visited.add(childId); }});
            }
            return subordinates;
        }

        function calculateGroupOrStructureData(leaderId, type = 'gruppe', fullDataStore) {
            const leaderUser = findRowById('mitarbeiter', leaderId);
            if (!leaderUser) return { members: [] };

            // 1. Definiere, welche Mitarbeiter angezeigt werden sollen
            const membersForDisplay = getSubordinates(leaderId, type);
            const memberIdsForDisplay = new Set(membersForDisplay.map(m => m._id));

            // 2. Definiere, wessen Daten für die Gesamtberechnung herangezogen werden, basierend auf dem Typ
            let membersForCalculation = [];
            if (type === 'gruppe') {
                // Für 'Gruppe': Die Führungskraft selbst und alle unterstellten Trainees,
                // bis zur nächsten Führungskraft in der Hierarchie.
                membersForCalculation = [leaderUser, ...getSubordinates(leaderId, 'gruppe')];
            } else { // type === 'struktur'
                // Für 'Struktur': Die Führungskraft selbst und ALLE Untergebenen (Führungskräfte und Trainees)
                membersForCalculation = [leaderUser, ...getAllSubordinatesRecursive(leaderId)];
            }
            const memberIdsForCalc = new Set(membersForCalculation.map(m => m._id));

            // 3. Filtere den vorab geladenen Datenspeicher
            const dataForCalc = fullDataStore.filter(d => memberIdsForCalc.has(d.id));

            // 4. Berechne die Summen aus den gefilterten Daten
            const totalEhGoal = dataForCalc.reduce((sum, d) => sum + (d.ehGoal || 0), 0);
            const totalEhCurrent = dataForCalc.reduce((sum, d) => sum + (d.ehCurrent || 0), 0);
            const totalEtGoal = dataForCalc.reduce((sum, d) => sum + (d.etGoal || 0), 0);
            const totalEtCurrent = dataForCalc.reduce((sum, d) => sum + (d.etCurrent || 0), 0);
            const totalAtGoal = dataForCalc.reduce((sum, d) => sum + (d.atGoal || 0), 0);
            const totalAtCurrent = dataForCalc.reduce((sum, d) => sum + (d.atCurrent || 0), 0);
            const totalAtVereinbart = dataForCalc.reduce((sum, d) => sum + (d.atVereinbart || 0), 0);

            // 5. Hole die Daten für die anzuzeigenden Karten aus dem Datenspeicher
            const memberData = fullDataStore.filter(d => memberIdsForDisplay.has(d.id));

            return {
                ehGoal: totalEhGoal,
                ehCurrent: totalEhCurrent,
                etGoal: totalEtGoal,
                etCurrent: totalEtCurrent,
                atGoal: totalAtGoal,
                atCurrent: totalAtCurrent,
                atVereinbart: totalAtVereinbart,
                members: memberData
            };
        }

        async function calculateGesamtansichtData() {
            const führungskräfte = db.mitarbeiter.filter(m => m.Karrierestufe && !m.Karrierestufe.toLowerCase().includes('trainee'));
            const geschäftsstelleRows = db.mitarbeiter.filter(m => m.Name && m.Name.toLowerCase().startsWith('geschäftsstelle'));
            const allMemberIds = new Set([...führungskräfte.map(fk => fk._id), ...geschäftsstelleRows.map(gs => gs._id)]);
            const allMemberData = await fetchBulkDashboardData(Array.from(allMemberIds));
            const totalData = { ehGoal: 0, ehCurrent: 0, etGoal: 0, etCurrent: 0, atGoal: 0, atCurrent: 0, atVereinbart: 0, members: [] };
            geschäftsstelleRows.forEach(gsRow => {
                const gsData = allMemberData.find(d => d.id === gsRow._id);
                if (gsData) { Object.keys(totalData).forEach(key => { if (typeof totalData[key] === 'number') totalData[key] += gsData[key] || 0; }); }
            });
            totalData.members = führungskräfte.map(leader => {
                const gsName = `Geschäftsstelle ${leader.Name}`;
                const gsRow = geschäftsstelleRows.find(row => row.Name === gsName);
                const targetId = gsRow ? gsRow._id : leader._id;
                const displayData = allMemberData.find(d => d.id === targetId);
                return { ...(displayData || {}), leaderName: leader.Name, originalPosition: leader.Karrierestufe };
            });
            
            return totalData;
        }

        // --- UI FUNKTIONEN ---
        function updateWeeklyProgress() {
            clearChildren(dom.weeklyProgressContainer);
        }

        function updateMonthlyPlanningView(data) {
            updateWeeklyProgress();
            animateValue(dom.ehCenterCurrent, 0, data.ehCurrent || 0, 1000);
            dom.ehCenterGoal.textContent = (data.ehGoal || 0).toLocaleString('de-DE');
            const ehPercentage = (data.ehGoal > 0) ? (data.ehCurrent / data.ehGoal * 100) : 0;
            updateCircleProgress(dom.ehProgressCircle, 45, ehPercentage);
            dom.appointmentsText.textContent = `${data.atCurrent || 0} / ${data.atVereinbart || 0} / ${data.atGoal || 0}`;
            const vereinbartPercent = data.atGoal > 0 ? (data.atVereinbart / data.atGoal) * 100 : 0;
            const gehaltenPercent = data.atGoal > 0 ? (data.atCurrent / data.atGoal) * 100 : 0;
            dom.appointmentsVereinbartBar.style.width = `${Math.min(vereinbartPercent, 100)}%`;
            dom.appointmentsGehaltenBar.style.width = `${Math.min(gehaltenPercent, 100)}%`;
            animateValue(dom.etCurrentDisplay, 0, data.etCurrent || 0, 1000, false);
            dom.etGoalDisplay.textContent = (data.etGoal || 0).toLocaleString('de-DE');
            const etPercent = data.etGoal > 0 ? (data.etCurrent / data.etGoal) * 100 : 0;
            if(dom.interviewsProgressBar) dom.interviewsProgressBar.style.width = `${Math.min(etPercent, 100)}%`;
        }

        function updateEmployeeCareerView() {
            const { totalCurrentEh, recruitedEmployees, position } = personalData;
            animateValue(dom.currentEhDisplay, 0, totalCurrentEh, 1500);
            const currentStage = db.karriereplan.find(k => k.Stufe === position);
            if (!currentStage) {
                console.error("Aktuelle Karrierestufe nicht im Karriereplan gefunden:", position);
                return;
            }
            const nextStage = db.karriereplan.filter(k => k.Hierarchie > currentStage.Hierarchie).sort((a, b) => a.Hierarchie - b.Hierarchie)[0];
            if (nextStage) {
                dom.nextMilestone.innerHTML = `Nächster Meilenstein: <span class="text-skt-blue font-semibold">${nextStage.Stufe}</span>`;
                const ehNeeded = nextStage.Kriterium_EH || 0;
                const progressEh = ehNeeded > 0 ? (totalCurrentEh / ehNeeded) * 100 : 0;
                dom.careerProgressPercentage.textContent = `${Math.min(progressEh, 100).toFixed(1)}%`;
                dom.progressToNextText.textContent = `Fortschritt zum ${nextStage.Stufe}`;
                updateCircleProgress(dom.fortschrittKreisKarriere, 40, progressEh);
                const maNeeded = nextStage.Kriterium_MA || 0;
                dom.employeeCountDisplay.textContent = `${recruitedEmployees} / ${maNeeded}`;
                dom.employeeGoalStatus.textContent = `Ziel: ${maNeeded} MA`;
                clearChildren(dom.employeeSlotsContainer);
                for (let i = 0; i < maNeeded; i++) {
                    const slot = document.createElement('div');
                    slot.className = `employee-slot ${i < recruitedEmployees ? 'filled' : ''}`;
                    dom.employeeSlotsContainer.appendChild(slot);
                }
            } else {
                dom.nextMilestone.innerHTML = 'Höchste Stufe erreicht!';
                dom.careerProgressPercentage.textContent = "100%";
                updateCircleProgress(dom.fortschrittKreisKarriere, 40, 100);
            }
            const careerPlanTiers = db.karriereplan.filter(p => (p.Stufe && (p.Stufe.toLowerCase().includes('trainee') || p.Stufe.toLowerCase().includes('jgst')))).sort((a,b) => a.Hierarchie - b.Hierarchie);
            let currentTierIndex = -1;
            for (let i = careerPlanTiers.length - 1; i >= 0; i--) {
                if (totalCurrentEh >= careerPlanTiers[i].Kriterium_EH) {
                    currentTierIndex = i;
                    break;
                }
            }
            dom.tierCards.forEach((card, i) => {
                if (i < careerPlanTiers.length) {
                    card.querySelector('h3').textContent = careerPlanTiers[i].Stufe;
                    card.querySelector('p').textContent = `${(careerPlanTiers[i].Kriterium_EH || 0).toLocaleString('de-DE')} EH`;
                    card.classList.toggle('active', i === currentTierIndex);
                    let progress = 0;
                    if (i < currentTierIndex) {
                        progress = 100;
                    } else if (i === currentTierIndex) {
                        const tierStart = careerPlanTiers[i].Kriterium_EH || 0;
                        const nextTierGoal = (i + 1 < careerPlanTiers.length) ? (careerPlanTiers[i+1].Kriterium_EH || 0) : tierStart;
                        if (nextTierGoal > tierStart) {
                            progress = ((totalCurrentEh - tierStart) / (nextTierGoal - tierStart)) * 100;
                        } else {
                            progress = (totalCurrentEh >= tierStart) ? 100 : 0;
                        }
                    }
                    dom.tierProgressBars[i].style.width = `${Math.min(progress, 100)}%`;
                }
            });
        }
        
        function updateLeadershipView() {
            if (currentPlanningView === 'personal' && !isSuperuserView) {
                dom.leadershipView.classList.add('hidden');
                return;
            }
            dom.leadershipView.classList.remove('hidden');
            let data, title;
            if (isSuperuserView) {
                data = personalData; 
                title = "Führungskräfte-Übersicht";
            } else if (currentPlanningView === 'struktur') {
                data = structureData;
                title = "Struktur-Übersicht";
            } else { 
                data = teamData;
                title = "Gruppen-Übersicht";
            }
            dom.leadershipViewTitle.textContent = title;
            
            dom.leadershipViewCount.textContent = `Zeige ${data.members.length} Mitarbeiter`;
            renderTeamMemberCards(data.members);
        }

        function renderTeamMemberCards(members) {
            clearChildren(dom.teamMembersContainer);
            clearChildren(dom.passiveMembersSection);
            dom.teamMembersContainer.className = 'mt-6'; 
            if (!members || members.length === 0) {
                dom.teamMembersContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">Keine Mitarbeiter in dieser Ansicht.</p>`;
                return;
            }
            const activeMembers = members.filter(m => m.ehGoal > 0 || m.etGoal > 0);
            const passiveMembers = members.filter(m => m.ehGoal === 0 && m.etGoal === 0);
            const { startDate, endDate } = getMonthlyCycleDates();
            const totalDaysInCycle = (endDate - startDate) / (1000 * 60 * 60 * 24);
            const daysPassedInCycle = Math.max(0, (new Date() - startDate) / (1000 * 60 * 60 * 24));
            if (currentLeadershipViewMode === 'grid') {
                dom.teamMembersContainer.className = 'mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';
            } else {
                dom.teamMembersContainer.className = 'mt-6 space-y-4';
            }
            activeMembers.forEach(member => {
                const card = createTeamMemberCard(member, totalDaysInCycle, daysPassedInCycle);
                dom.teamMembersContainer.appendChild(card);
            });
            if (passiveMembers.length > 0) {
                const details = document.createElement('details');
                details.className = 'bg-white rounded-xl shadow-lg';
                const summary = document.createElement('summary');
                summary.className = 'p-4 font-semibold text-skt-blue cursor-pointer';
                summary.textContent = `Passive Mitarbeiter (${passiveMembers.length})`;
                details.appendChild(summary);
                const container = document.createElement('div');
                container.className = 'p-4 pt-0 space-y-3';
                passiveMembers.forEach(member => {
                    const passiveCard = document.createElement('div');
                    passiveCard.className = 'p-3 bg-skt-grey-light rounded-lg flex justify-between items-center';
                    passiveCard.innerHTML = `<div><p class="font-bold text-skt-blue">${member.name}</p><p class="text-sm text-skt-blue-light">${member.position}</p></div><button data-userid="${member.id}" class="switch-view-btn text-skt-blue-light hover:text-skt-blue-main transition-colors" title="Zur Ansicht wechseln"><i class="fas fa-eye"></i></button>`;
                    passiveCard.querySelector('.switch-view-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        const userId = e.currentTarget.dataset.userid;
                        if(userId) fetchAndRenderDashboard(userId);
                    });
                    container.appendChild(passiveCard);
                });
                details.appendChild(container);
                dom.passiveMembersSection.appendChild(details);
            }
        }
        
        function createTeamMemberCard(member, totalDaysInCycle, daysPassedInCycle) {
            const prognosis = getPrognosis(member.ehCurrent, member.ehGoal, totalDaysInCycle, daysPassedInCycle);
            const etPercentage = member.etGoal > 0 ? (member.etCurrent / member.etGoal * 100) : 0;
            let ehValue = member.ehCurrent;
            let ehGoal = member.ehGoal;
            let ehUnit = 'Einheiten (EH)';
            if (isMoneyView) {
                const { startDate, endDate } = getMonthlyCycleDates();
                ehValue = calculateTotalEarnings(member.id, startDate, endDate);
                ehGoal = 0;
                ehUnit = 'Verdienst (€)';
            }
            const ehPercentage = member.ehGoal > 0 ? (member.ehCurrent / member.ehGoal * 100) : 0;
            const ehColorClass = getProgressColorClass(member.ehCurrent, member.ehGoal, totalDaysInCycle, daysPassedInCycle);
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg transition-shadow hover:shadow-xl';
            const summary = document.createElement('div');
            summary.className = 'p-4 cursor-pointer';
            const pos = member.position || "";
            const positionHtml = pos && !pos.toLowerCase().includes('trainee') ? `<p class="text-sm text-skt-blue-light">${member.originalPosition || member.position}</p>` : '';
            summary.innerHTML = `<div class="flex justify-between items-start gap-2"><div class="min-w-0"><p class="font-bold text-skt-blue text-lg break-words">${member.leaderName || member.name}</p>${positionHtml}</div><div class="flex items-center space-x-4 flex-shrink-0"><span class="font-semibold text-sm ${prognosis.colorClass}" data-tooltip="Prognose basierend auf dem aktuellen Fortschritt im Verhältnis zur vergangenen Zeit im Monat.">${prognosis.text}</span><button data-userid="${member.id}" class="switch-view-btn text-skt-blue-light hover:text-skt-blue-main transition-colors" title="Zur Ansicht wechseln"><i class="fas fa-eye"></i></button><i class="fas fa-chevron-down chevron-icon text-skt-blue-light"></i></div></div><div class="mt-2"><div class="flex justify-between items-baseline"><p class="text-xs text-skt-blue-light">${ehUnit}</p><p class="text-xs font-semibold text-skt-blue">${ehValue.toLocaleString('de-DE', {maximumFractionDigits: 0})} ${isMoneyView ? '' : `/ ${ehGoal.toLocaleString('de-DE', {maximumFractionDigits: 0})}`}</p></div>${!isMoneyView ? `<div class="w-full bg-skt-grey-medium h-2.5 rounded-full overflow-hidden mt-1"><div class="h-full ${ehColorClass}" style="width: ${Math.min(ehPercentage, 100)}%;"></div></div>` : ''}</div><div class="mt-2"><div class="flex justify-between items-baseline"><p class="text-xs text-skt-blue-light">ET Termine</p><p class="text-xs font-semibold text-skt-blue">${member.etCurrent} / ${member.etGoal}</p></div><div class="w-full bg-skt-grey-medium h-2.5 rounded-full overflow-hidden mt-1"><div class="h-full bg-skt-green-accent" style="width: ${Math.min(etPercentage, 100)}%;"></div></div></div>`;
            const details = document.createElement('div');
            details.className = 'team-member-details px-4';
            details.innerHTML = `<div class="details-grid grid grid-cols-1 gap-4"><div class="text-center"><p class="text-sm font-semibold text-skt-blue mb-1">Analysetermine</p><p class="text-md font-bold text-skt-blue">${member.atCurrent} / ${member.atVereinbart} / ${member.atGoal}</p><p class="text-xs text-gray-500 mb-2">Gehalten / Vereinbart / Soll</p><div class="w-full bg-skt-grey-medium h-2.5 rounded-full overflow-hidden relative"><div class="h-full bg-skt-blue-accent absolute top-0 left-0 transition-all duration-700 ease-out" style="width: ${Math.min(member.atGoal > 0 ? (member.atVereinbart / member.atGoal) * 100 : 0, 100)}%;"></div><div class="h-full bg-skt-green-accent absolute top-0 left-0 transition-all duration-700 ease-out" style="width: ${Math.min(member.atGoal > 0 ? (member.atCurrent / member.atGoal) * 100 : 0, 100)}%;"></div></div></div></div>`;
            card.appendChild(summary);
            card.appendChild(details);
            summary.addEventListener('click', (e) => { if (!e.target.closest('.switch-view-btn')) { details.classList.toggle('open'); summary.classList.toggle('open'); } });
            summary.querySelector('.switch-view-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const newuserId = e.currentTarget.dataset.userid;
                if (newuserId) {
                    viewHistory.push(newuserId);
                    fetchAndRenderDashboard(newuserId);
                }
            });
            return card;
        }

        function fetchNextInfoDate() { return "Datum unbekannt"; }
        
        function updateBackButtonVisibility() {
            const shouldShow = viewHistory.length > 1 || isSuperuserView || currentView === 'einarbeitung';
            dom.backButton.classList.toggle('hidden', !shouldShow);
        }

        // --- MAIN LOGIC ---
        
        async function fetchAndRenderDashboard(mitarbeiterId) {
            window.scrollTo(0, 0);
            setStatus('Lade & verarbeite Daten...');
            dom.dashboardSections.classList.add('opacity-0');
            
            const user = findRowById('mitarbeiter', mitarbeiterId);
            if (!user) {
                setStatus(`Benutzer mit ID ${mitarbeiterId} nicht gefunden.`, true);
                return;
            }
            
            // --- OPTIMIERTER DATENABRUF ---
            // 1. Hole alle relevanten Mitarbeiter-IDs (sich selbst + gesamte Downline)
            const allDownline = getAllSubordinatesRecursive(mitarbeiterId);
            const allRelevantIds = [mitarbeiterId, ...allDownline.map(u => u._id)];
            // 2. Führe EINEN gebündelten Datenabruf für alle relevanten Mitarbeiter aus
            const fullDataStore = await fetchBulkDashboardData(allRelevantIds);
            // --- ENDE OPTIMIERTER DATENABRUF ---

            personalData = fullDataStore.find(d => d.id === mitarbeiterId) || {};
            await checkAndApplyAutomaticPromotion(mitarbeiterId, personalData.totalCurrentEh);
            
            loggedInUserData = user;
            dom.welcomeHeader.textContent = `Willkommen, ${user.Name}`;
            dom.userPosition.textContent = user.Karrierestufe;

            const position = user.Karrierestufe || "";
            const isLeader = !position.toLowerCase().includes('trainee');
            if (isLeader) {
                teamData = calculateGroupOrStructureData(mitarbeiterId, 'gruppe', fullDataStore);
                structureData = calculateGroupOrStructureData(mitarbeiterId, 'struktur', fullDataStore);
                
                currentPlanningView = 'team';
                dom.teamViewBtn.classList.add('active');
                dom.personalViewBtn.classList.remove('active');
                dom.strukturViewBtn.classList.remove('active');
                dom.monthlyPlanningTitle.textContent = "Gruppen-Übersicht";
                updateMonthlyPlanningView(teamData);
                updateLeadershipView();
            } else {
                currentPlanningView = 'personal';
                dom.monthlyPlanningTitle.textContent = "Deine Monatsplanung";
                updateMonthlyPlanningView(personalData);
                updateEmployeeCareerView();
            }

            dom.employeeView.classList.toggle('hidden', isLeader);
            dom.leadershipView.classList.toggle('hidden', !isLeader);
            dom.planningViewToggle.classList.toggle('hidden', !isLeader);
            dom.einarbeitungBanner.classList.toggle('hidden', isLeader);
            
            let nextInfoDateEl = document.getElementById('next-info-date');
            if (!nextInfoDateEl) {
                nextInfoDateEl = document.createElement('p');
                nextInfoDateEl.id = 'next-info-date';
                nextInfoDateEl.className = 'text-center text-sm text-skt-blue-light mt-4';
                dom.monthlyPlanningView.appendChild(nextInfoDateEl);
            }
            nextInfoDateEl.textContent = `Nächstes Info: ${fetchNextInfoDate()}`;


            setStatus('');
            dom.dashboardSections.classList.remove('hidden');
            setTimeout(() => dom.dashboardSections.classList.remove('opacity-0'), 50);
            updateBackButtonVisibility();
        }
        
        async function renderSuperuserView() {
            isSuperuserView = true;
            setStatus('Lade Gesamtansicht...');
            dom.dashboardSections.classList.add('opacity-0');

            const gesamtData = await calculateGesamtansichtData();
            personalData = gesamtData; 
            
            dom.monthlyPlanningTitle.textContent = "Gesamtansicht";
            updateMonthlyPlanningView(gesamtData);
            
            currentPlanningView = 'team';
            updateLeadershipView();

            dom.employeeView.classList.add('hidden');
            dom.leadershipView.classList.remove('hidden');
            dom.planningViewToggle.classList.add('hidden');

            setStatus('');
            dom.dashboardSections.classList.remove('hidden');
            setTimeout(() => dom.dashboardSections.classList.remove('opacity-0'), 50);
            updateBackButtonVisibility();
        }

        // --- Einarbeitung (Onboarding) Logic ---
        async function fetchAndRenderOnboarding(mitarbeiterId) {
             const user = findRowById('mitarbeiter', mitarbeiterId);
             if (!user) return;
            
             const position = user.Karrierestufe || "";
             const isTrainee = position.toLowerCase().includes('trainee');

             if (isTrainee) {
                 dom.einarbeitungTitle.textContent = "Dein Einarbeitungsplan";
                 dom.leaderOnboardingView.classList.add('hidden');
                 dom.traineeOnboardingView.classList.remove('hidden');
                 await renderTraineeOnboardingView(mitarbeiterId);
             } else {
                 currentOnboardingSubView = 'leader-list';
                 dom.einarbeitungTitle.textContent = "Einarbeitung: Gruppen-Übersicht";
                 dom.traineeOnboardingView.classList.add('hidden');
                 dom.leaderOnboardingView.classList.remove('hidden');
                 const teamMembers = getSubordinates(mitarbeiterId, 'gruppe');
                 await renderLeaderOnboardingView(teamMembers);
             }
        }

        async function renderLeaderOnboardingView(teamMembers) {
              clearChildren(dom.leaderOnboardingView);
              dom.leaderOnboardingView.innerHTML = `<div class="loader mx-auto"></div>`;

              if (teamMembers.length === 0) {
                  dom.leaderOnboardingView.innerHTML = `<p class="text-center text-gray-500">Keiner deiner Mitarbeiter befindet sich aktuell in der Einarbeitung.</p>`;
                  return;
              }
              
              const container = document.createElement('div');
              container.className = 'space-y-4';

              const progressPromises = teamMembers.map(member => getOnboardingProgressForTrainee(member._id).then(data => ({member, data})));
              const results = await Promise.all(progressPromises);

              for (const {member, data: progressData} of results) {
                  if (progressData.totalSteps > 0) {
                       const card = document.createElement('div');
                       card.className = 'bg-skt-grey-light p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-200 transition-colors';
                       card.dataset.traineeId = member._id;
                       card.innerHTML = `
                           <div class="flex justify-between items-center mb-1">
                               <p class="font-bold text-skt-blue">${member.Name}</p>
                               <p class="font-semibold text-skt-blue-light">${progressData.percentage.toFixed(0)}%</p>
                           </div>
                           <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner relative">
                               <div class="bg-red-300 h-4 rounded-full absolute top-0 left-0 transition-all duration-700 ease-out" style="width: ${progressData.sollPercentage.toFixed(0)}%; z-index: 1;" data-tooltip="Soll-Fortschritt"></div>
                               <div class="bg-skt-green-accent h-4 rounded-full absolute top-0 left-0 transition-all duration-700 ease-out" style="width: ${progressData.percentage.toFixed(0)}%; z-index: 2;" data-tooltip="Ist-Fortschritt"></div>
                           </div>
                       `;
                       card.addEventListener('click', () => showTraineeDetailView(member._id));
                       container.appendChild(card);
                  }
              }
              
              clearChildren(dom.leaderOnboardingView);
              if (container.children.length === 0) {
                  dom.leaderOnboardingView.innerHTML = `<p class="text-center text-gray-500">Keiner deiner Mitarbeiter befindet sich aktuell in der Einarbeitung.</p>`;
              } else {
                  dom.leaderOnboardingView.appendChild(container);
              }
        }

        async function getOnboardingProgressForTrainee(traineeId) {
             const user = findRowById('mitarbeiter', traineeId);
             if (!user || !user.Name) return { percentage: 0, sollPercentage: 0, totalSteps: 0};
             
             const safeUserName = escapeSql(user.Name);
             const einarbeitungQuery = `SELECT \`Schritt_ID\` FROM \`Einarbeitung\` WHERE \`Mitarbeiter_ID\` = '${safeUserName}'`;
             const userEinarbeitungRaw = await seaTableSqlQuery(einarbeitungQuery);
             const userEinarbeitung = mapSqlResults(userEinarbeitungRaw, 'Einarbeitung');
             
             const allSteps = db.einarbeitungsschritte;

             if(allSteps.length === 0) return { percentage: 0, sollPercentage: 0, totalSteps: 0};

             const completedStepIds = new Set(userEinarbeitung.map(e => e['Schritt_ID'][0]));
             const completedSteps = allSteps.filter(s => completedStepIds.has(s._id)).length;
             const percentage = (completedSteps / allSteps.length) * 100;
             
             const userStartDate = user.Startdatum;
             let sollPercentage = 0;
             if (userStartDate) {
                 const startDate = new Date(userStartDate);
                 const overallStartDate = new Date(startDate);
                 overallStartDate.setDate(startDate.getDate() + allSteps[0]['Tage nach Start']);
                 const overallEndDate = new Date(startDate);
                 overallEndDate.setDate(startDate.getDate() + allSteps[allSteps.length - 1]['Tage nach Start']);
                 const today = new Date();
                 const totalPlanDuration = overallEndDate.getTime() - overallStartDate.getTime();
                 const elapsedPlanDuration = today.getTime() - overallStartDate.getTime();
                 if (totalPlanDuration > 0) {
                     sollPercentage = Math.max(0, Math.min(100, (elapsedPlanDuration / totalPlanDuration) * 100));
                 } else if (today >= overallStartDate) {
                     sollPercentage = 100;
                 }
             }

             return { percentage, sollPercentage, totalSteps: allSteps.length };
        }
        
        async function showTraineeDetailView(traineeId) {
            dom.leaderOnboardingView.classList.add('hidden');
            dom.traineeOnboardingView.classList.remove('hidden');
            const traineeName = findRowById('mitarbeiter', traineeId)?.Name || "Unbekannt";
            dom.einarbeitungTitle.textContent = `Einarbeitungsplan: ${traineeName}`;
            
            dom.grundseminarStepsContainer.innerHTML = `<div class="loader mx-auto mt-4"></div>`;
            dom.aufbauseminarStepsContainer.innerHTML = ``;
            document.getElementById('onboarding-progress-container').classList.add('hidden');

            await renderTraineeOnboardingView(traineeId);

            currentOnboardingSubView = 'trainee-detail';
            updateBackButtonVisibility();
        }

        async function renderTraineeOnboardingView(mitarbeiterId, forceShowAllCompleted = false) {
            const allSteps = db.einarbeitungsschritte.sort((a,b) => a.Tag - b.Tag);
            
            const user = findRowById('mitarbeiter', mitarbeiterId);
            if (!user || !user.Startdatum || !user.Name) {
                dom.traineeOnboardingView.innerHTML = `<p class="text-center text-red-500">Für diesen Mitarbeiter sind nicht alle Daten (Startdatum/Name) hinterlegt.</p>`;
                return;
            }
            
            const safeUserName = escapeSql(user.Name);
            const einarbeitungQuery = `SELECT \`Schritt_ID\` FROM \`Einarbeitung\` WHERE \`Mitarbeiter_ID\` = '${safeUserName}'`;
            const userEinarbeitungRaw = await seaTableSqlQuery(einarbeitungQuery);
            const userEinarbeitung = mapSqlResults(userEinarbeitungRaw, 'Einarbeitung');
            const completedStepIds = new Set(userEinarbeitung.map(e => e['Schritt_ID'][0]));

            const startDate = new Date(user.Startdatum);
            
            const processedSteps = allSteps.map(step => {
                const dueDate = new Date(startDate);
                dueDate.setDate(startDate.getDate() + (step.Tag || 0));
                return { ...step, dueDate, completed: completedStepIds.has(step._id) }
            });

             const aufbauStartIndex = processedSteps.findIndex(step => step.Schritt.toLowerCase().includes('aufbauseminar'));
             let grundseminarSteps = aufbauStartIndex !== -1 ? processedSteps.slice(0, aufbauStartIndex) : processedSteps;
             let aufbauseminarSteps = aufbauStartIndex !== -1 ? processedSteps.slice(aufbauStartIndex) : [];
             
            const progressData = await getOnboardingProgressForTrainee(mitarbeiterId);
            const progressContainer = document.getElementById('onboarding-progress-container');
            progressContainer.classList.remove('hidden');
            document.getElementById('onboarding-progress-bar').style.width = `${progressData.percentage}%`;
            document.getElementById('onboarding-progress-text').textContent = `${progressData.percentage.toFixed(0)}%`;
            document.getElementById('onboarding-soll-bar').style.width = `${progressData.sollPercentage}%`;

             renderTimelineSection(dom.grundseminarStepsContainer, dom.grundseminarProgress, dom.grundseminarDateMarkers, grundseminarSteps);
             renderTimelineSection(dom.aufbauseminarStepsContainer, dom.aufbauseminarProgress, dom.aufbauseminarDateMarkers, aufbauseminarSteps);
        }

        function renderTimelineSection(container, progressElement, dateMarkerContainer, steps) {
            clearChildren(container);
            
            if (steps.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 mt-4">Für diesen Abschnitt sind keine Schritte vorhanden.</p>';
                if (progressElement) progressElement.style.height = '0%';
                if (dateMarkerContainer) clearChildren(dateMarkerContainer);
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            steps.forEach((step, index) => {
                const stepEl = document.createElement('div');
                const stepType = step.Kategorie ? step.Kategorie.toLowerCase().trim() : 'other';
                const isMajor = stepType === 'meilenstein' || stepType === 'seminar';
                
                let statusClass = step.completed ? 'completed' : (step.dueDate <= today ? 'due' : 'future');
                const isOverdue = !step.completed && (today.getTime() - step.dueDate.getTime() > (3 * 24 * 60 * 60 * 1000));

                let iconClass = 'fa-question';
                switch(stepType) {
                    case 'seminar': iconClass = 'fa-book'; break;
                    case 'persönliches gespräch': iconClass = 'fa-users'; break;
                    case 'meilenstein': iconClass = 'fa-star'; break;
                    case 'hausübung': iconClass = 'fa-pencil-alt'; break;
                }

                stepEl.className = `timeline-item ${statusClass} ${stepType} ${isMajor ? 'timeline-item-major' : 'timeline-item-minor'}`;
                stepEl.style.animationDelay = `${index * 0.1}s`;
                
                const formattedDate = step.dueDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                stepEl.innerHTML = `
                    <div class="timeline-content ${isOverdue ? 'overdue-task' : ''}">
                        <div class="timeline-header">
                            <div class="timeline-icon-inline">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="timeline-info">
                                <p class="timeline-title">${step.Schritt}</p>
                                <p class="timeline-duedate">Fällig bis: ${formattedDate}</p>
                            </div>
                        </div>
                    </div>
                `;

                stepEl.querySelector('.timeline-content').addEventListener('click', () => {
                    dom.hinweisModalContent.textContent = step.Hinweis || 'Kein Hinweis verfügbar.';
                    dom.hinweisModal.classList.add('visible');
                    document.body.classList.add('modal-open');
                    document.documentElement.classList.add('modal-open');
                });
                
                container.appendChild(stepEl);
            });
        }
        
        // --- INITIALISIERUNG & EVENT LISTENERS ---

        function setupEventListeners() {
            // --- Dropdown Menu Logic ---
            function closeSettingsMenu() {
                if (dom.settingsMenu.classList.contains('visible')) {
                    dom.settingsMenu.classList.remove('visible');
                    dom.settingsMenu.addEventListener('transitionend', () => {
                        dom.settingsMenu.classList.add('hidden');
                    }, { once: true });
                }
            }

            dom.settingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const user = findRowById('mitarbeiter', localStorage.getItem('loggedInUserId'));
                if (isUserLeader(user)) {
                    dom.superuserBtn.classList.remove('hidden');
                } else {
                    dom.superuserBtn.classList.add('hidden');
                }
                
                if (dom.settingsMenu.classList.contains('hidden')) {
                    dom.settingsMenu.classList.remove('hidden');
                    setTimeout(() => dom.settingsMenu.classList.add('visible'), 10);
                } else {
                    closeSettingsMenu();
                }
            });

            document.addEventListener('click', (e) => {
                if (!dom.settingsMenu.contains(e.target) && !dom.settingsBtn.contains(e.target)) {
                    closeSettingsMenu();
                }
            });

            // --- User Login ---
            dom.userDropdownSelect.addEventListener('change', () => {
                document.getElementById('password-container').classList.remove('hidden');
                document.getElementById('start-dashboard-btn').classList.remove('hidden');
                document.getElementById('password-input').focus();
            });

            document.getElementById('start-dashboard-btn').addEventListener('click', async () => {
                const selectedUserId = dom.userDropdownSelect.value;
                const enteredPassword = document.getElementById('password-input').value;
                
                if (!selectedUserId) {
                    dom.userSelectError.textContent = "Bitte einen Benutzer wählen.";
                    return;
                }
                
                const user = findRowById('mitarbeiter', selectedUserId);
                
                if (user && user.PWD === enteredPassword) {
                    localStorage.setItem('loggedInUserId', selectedUserId);
                    viewHistory = [selectedUserId];
                    document.getElementById('user-select-screen').classList.add('hidden');
                    document.getElementById('dashboard-content').classList.remove('hidden');
                    fetchAndRenderDashboard(selectedUserId);
                } else {
                    dom.userSelectError.textContent = "Falsches Passwort oder Benutzer nicht gefunden.";
                }
            });

            document.getElementById('password-input').addEventListener('keydown', e => {
                if (e.key === 'Enter') document.getElementById('start-dashboard-btn').click();
            });

            // --- Menu Actions ---
            dom.logoutBtn.addEventListener('click', () => {
                closeSettingsMenu();
                localStorage.clear(); // Löscht alles, inkl. Cache und Login-Status
                location.reload();
            });
            
            dom.clearCacheBtn.addEventListener('click', () => {
                closeSettingsMenu();
                localStorage.clear(); // Löscht alles, inkl. Cache und Login-Status
                location.reload();
            });
            
            dom.clearCacheBtn.addEventListener('click', () => {
                closeSettingsMenu();
                localStorage.clear();
                location.reload();
            });
            
             dom.moneyViewBtn.addEventListener('click', async (e) => {
                  e.preventDefault();
                  closeSettingsMenu();
                  isMoneyView = !isMoneyView;
                  dom.moneyViewBtn.innerHTML = isMoneyView 
                      ? `<i class="fas fa-chart-pie w-5 mr-2"></i>EH-Ansicht` 
                      : `<i class="fas fa-euro-sign w-5 mr-2"></i>Geld-Ansicht`;
                  
                  const currentUser = viewHistory[viewHistory.length - 1];
                  if (isSuperuserView) {
                       await renderSuperuserView();
                  } else if (currentUser) {
                       await fetchAndRenderDashboard(currentUser);
                  }
             });
            
            dom.superuserBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                closeSettingsMenu();
                await renderSuperuserView();
            });

             dom.editUserBtn.addEventListener('click', (e) => {
                  e.preventDefault();
                  closeSettingsMenu();
                  openEditUserModal();
             });

            // --- Main Navigation ---
            dom.backButton.addEventListener('click', async () => {
                if (isSuperuserView) {
                    isSuperuserView = false;
                    const userId = localStorage.getItem('loggedInUserId');
                    await fetchAndRenderDashboard(userId);
                    return;
                }
                if (currentView === 'einarbeitung') {
                    const currentUser = findRowById('mitarbeiter', loggedInUserData._id);
                    if (currentOnboardingSubView === 'trainee-detail' && isUserLeader(currentUser)) {
                        const teamMembers = getSubordinates(loggedInUserData._id, 'gruppe');
                        await renderLeaderOnboardingView(teamMembers);
                        currentOnboardingSubView = 'leader-list';
                        dom.einarbeitungTitle.textContent = "Einarbeitung: Gruppen-Übersicht";
                        dom.leaderOnboardingView.classList.remove('hidden');
                        dom.traineeOnboardingView.classList.add('hidden');
                    } else {
                        switchView('dashboard');
                    }
                    updateBackButtonVisibility();
                    return;
                }
                if (viewHistory.length > 1) {
                    viewHistory.pop();
                    const previousUserId = viewHistory[viewHistory.length - 1];
                    await fetchAndRenderDashboard(previousUserId);
                }
            });

            // --- View Toggles ---
            dom.personalViewBtn.addEventListener('click', () => {
                currentPlanningView = 'personal';
                dom.personalViewBtn.classList.add('active');
                dom.teamViewBtn.classList.remove('active');
                dom.strukturViewBtn.classList.remove('active');
                dom.monthlyPlanningTitle.textContent = "Deine Monatsplanung";
                updateMonthlyPlanningView(personalData);
                updateLeadershipView();
            });
            dom.teamViewBtn.addEventListener('click', () => {
                currentPlanningView = 'team';
                dom.teamViewBtn.classList.add('active');
                dom.personalViewBtn.classList.remove('active');
                dom.strukturViewBtn.classList.remove('active');
                dom.monthlyPlanningTitle.textContent = "Gruppen-Übersicht";
                updateMonthlyPlanningView(teamData);
                updateLeadershipView();
            });
            dom.strukturViewBtn.addEventListener('click', () => {
                currentPlanningView = 'struktur';
                dom.strukturViewBtn.classList.add('active');
                dom.teamViewBtn.classList.remove('active');
                dom.personalViewBtn.classList.remove('active');
                dom.monthlyPlanningTitle.textContent = "Struktur-Übersicht";
                updateMonthlyPlanningView(structureData);
                updateLeadershipView();
            });
            
            dom.gridViewBtn.addEventListener('click', () => {
                if (currentLeadershipViewMode === 'grid') return;
                currentLeadershipViewMode = 'grid';
                dom.gridViewBtn.classList.add('active');
                dom.listViewBtn.classList.remove('active');
                updateLeadershipView();
            });

            dom.listViewBtn.addEventListener('click', () => {
                if (currentLeadershipViewMode === 'list') return;
                currentLeadershipViewMode = 'list';
                dom.listViewBtn.classList.add('active');
                dom.gridViewBtn.classList.remove('active');
                updateLeadershipView();
            });

            // --- Onboarding Navigation ---
            dom.einarbeitungBtn.addEventListener('click', () => {
                switchView('einarbeitung');
                fetchAndRenderOnboarding(loggedInUserData._id);
            });
            dom.einarbeitungBanner.addEventListener('click', () => {
                 switchView('einarbeitung');
                 fetchAndRenderOnboarding(loggedInUserData._id);
            });

            // --- Modal Controls ---
            dom.closeHinweisModalBtn.addEventListener('click', () => {
                dom.hinweisModal.classList.remove('visible');
                document.body.classList.remove('modal-open');
                document.documentElement.classList.remove('modal-open');
            });
             dom.hinweisModal.addEventListener('click', (e) => {
                  if(e.target === dom.hinweisModal) {
                      dom.hinweisModal.classList.remove('visible');
                      document.body.classList.remove('modal-open');
                      document.documentElement.classList.remove('modal-open');
                  }
             });

            dom.aiAssistantBtn.addEventListener('click', handleAIAssistantClick);
            
            dom.editUserForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveUserData();
            });
            dom.cancelEditUserBtn.addEventListener('click', closeEditUserModal);
            dom.cancelEditUserBtn2.addEventListener('click', closeEditUserModal);
        }
        
        function switchView(viewName) {
            currentView = viewName;
            dom.mainDashboardView.classList.toggle('hidden', viewName === 'einarbeitung');
            dom.einarbeitungView.classList.toggle('hidden', viewName !== 'einarbeitung');
            updateBackButtonVisibility();
        }

        let isInitializing = false;
        async function initializeDashboard() {
            if (isInitializing) {
                console.warn("Initialisierung bereits im Gange. Überspringe.");
                return;
            }
            isInitializing = true;

            const dataLoaded = await loadAllData();

            if (!dataLoaded) {
                setStatus("Initialisierung fehlgeschlagen. Bitte Seite neu laden.", true);
                isInitializing = false;
                return;
            }
            
            const usersForLogin = db.mitarbeiter.filter(m => m.Name);
            usersForLogin.sort((a, b) => a.Name.localeCompare(b.Name));
            usersForLogin.forEach(user => {
                const option = document.createElement('option');
                option.value = user._id;
                option.textContent = user.Name;
                dom.userDropdownSelect.appendChild(option);
            });
            
            const loggedInUserId = localStorage.getItem('loggedInUserId');
            if (loggedInUserId && findRowById('mitarbeiter', loggedInUserId)) {
                viewHistory = [loggedInUserId];
                document.getElementById('user-select-screen').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');
                await fetchAndRenderDashboard(loggedInUserId);
            } else {
                document.getElementById('user-select-screen').classList.remove('hidden');
                document.getElementById('user-select-screen').classList.add('flex');
                setStatus('');
            }
            
            setupEventListeners();
            isInitializing = false;
        }
        
        function getPrognosis(current, goal, totalDays, daysPassed) {
            if (goal <= 0 || daysPassed <= 0) return { text: '-', colorClass: 'text-gray-500' };
            const dailyRate = current / daysPassed;
            const prognosis = dailyRate * totalDays;
            
            if (prognosis >= goal) return { text: `↗ ${Math.round(prognosis)}`, colorClass: 'text-skt-green-accent' };
            if (prognosis >= goal * 0.8) return { text: `→ ${Math.round(prognosis)}`, colorClass: 'text-skt-yellow-accent' };
            return { text: `↘ ${Math.round(prognosis)}`, colorClass: 'text-skt-red-accent' };
        }

        function getProgressColorClass(current, goal, totalDays, daysPassed) {
            if (goal <= 0) return 'bg-skt-grey-medium';
            const progressRatio = current / goal;
            if (progressRatio >= 1) return 'bg-skt-green-accent';
            if (daysPassed <= 0) return 'bg-skt-green-accent';

            const timeRatio = daysPassed / totalDays;

            if (progressRatio >= timeRatio) return 'bg-skt-green-accent';
            if (progressRatio >= timeRatio * 0.75) return 'bg-skt-yellow-accent';
            return 'bg-skt-red-accent';
        }
        
        function getVerdienstForPosition(position) {
            const plan = db.karriereplan.find(p => p.Stufe === position);
            return plan ? (plan.Verdienst || 0) : 0;
        }

        async function calculateTotalEarnings(leaderId, startDate, endDate) {
            const leader = findRowById('mitarbeiter', leaderId);
            if (!leader || !leader.Name) return 0;
            
            const startDateIso = startDate.toISOString().split('T')[0];
            const endDateIso = endDate.toISOString().split('T')[0];

            const allSubordinates = getAllSubordinatesRecursive(leaderId);
            const structureMembers = [leader, ...allSubordinates];

            // Abfrage holt alle Umsätze im Zeitraum; Filterung per ID im Code.
            const turnoverQuery = `SELECT \`Mitarbeiter_ID\`, SUM(\`EH\`) AS \`turnover\` FROM \`Umsatz\` WHERE \`Datum\` >= '${startDateIso}' AND \`Datum\` <= '${endDateIso}' GROUP BY \`Mitarbeiter_ID\``;
            
            // Abfrage mit `convertLinks = false` für stabile IDs.
            const turnoverResultsRaw = await seaTableSqlQuery(turnoverQuery, false);
            const structureTurnovers = mapSqlResults(turnoverResultsRaw, 'Umsatz');
            
            const getTurnoverForMember = (memberId) => {
                // KORREKTUR: Die ID befindet sich in der `row_id` Eigenschaft des ersten Objekts im Array.
                const result = structureTurnovers.find(s => s.Mitarbeiter_ID && Array.isArray(s.Mitarbeiter_ID) && s.Mitarbeiter_ID[0] && s.Mitarbeiter_ID[0].row_id === memberId);
                return result?.turnover || 0;
            };

            const leaderRate = getVerdienstForPosition(leader.Karrierestufe);
            let totalEarnings = getTurnoverForMember(leader._id) * leaderRate;
            const directSubordinates = db.mitarbeiter.filter(m => m.Werber === leaderId);

            directSubordinates.forEach(sub => {
                const subRate = getVerdienstForPosition(sub.Karrierestufe);
                const differentialRate = leaderRate - subRate;
                if (differentialRate > 0) {
                    const subAndHisTeam = [sub, ...getAllSubordinatesRecursive(sub._id)];
                    const subStructureTurnover = subAndHisTeam.reduce((total, currentMember) => total + getTurnoverForMember(currentMember._id), 0);
                    totalEarnings += subStructureTurnover * differentialRate;
                }
            });

            return totalEarnings;
        }

        async function checkAndApplyAutomaticPromotion(mitarbeiterId, totalEh) {
            const user = findRowById('mitarbeiter', mitarbeiterId);
            if (!user || !user.Karrierestufe) return;
            const recruitedEmployees = db.mitarbeiter.filter(m => m.Werber === mitarbeiterId).length;

            const currentStage = db.karriereplan.find(p => p.Stufe === user.Karrierestufe);
            if (!currentStage) return;

            const nextStage = db.karriereplan
                .filter(p => p.Hierarchie > currentStage.Hierarchie)
                .sort((a, b) => a.Hierarchie - b.Hierarchie)[0];
            
            if (nextStage && nextStage.AutomatischeBefoerderung) {
                if (totalEh >= nextStage.Kriterium_EH && recruitedEmployees >= nextStage.Kriterium_MA) {
                    const userInDb = db.mitarbeiter.find(u => u._id === mitarbeiterId);
                    if(userInDb && userInDb.Karrierestufe !== nextStage.Stufe) {
                        userInDb.Karrierestufe = nextStage.Stufe;
                        console.log(`Mitarbeiter ${user.Name} wurde automatisch zu ${nextStage.Stufe} befördert (visuell).`);
                    }
                }
            }
        }
        
        async function handleAIAssistantClick() {
            dom.hinweisModalTitle.textContent = "KI-Assistent";
            dom.hinweisModalContent.innerHTML = '<div class="loader mx-auto"></div>';
            dom.hinweisModal.classList.add('visible');
            document.body.classList.add('modal-open');

            const { name, position, ehCurrent, ehGoal, atCurrent, atGoal, etCurrent, etGoal } = personalData;

            const userPrompt = `
                Analysiere die folgenden Leistungsdaten für den Mitarbeiter ${name} (${position}) und gib eine kurze, motivierende Zusammenfassung und 2-3 konkrete, umsetzbare Tipps.
                - Aktuelle Einheiten (EH): ${ehCurrent} von ${ehGoal} geplant.
                - Aktuelle Analysetermine (AT): ${atCurrent} von ${atGoal} geplant.
                - Aktuelle Einstellungstermine (ET): ${etCurrent} von ${etGoal} geplant.
                
                Gib die Antwort auf Deutsch, direkt formuliert an den Mitarbeiter (Du-Form) und formatiere sie mit HTML (z.B. <strong> für wichtige Punkte und <ul>/<li> für die Tipps).
            `;

            const systemPrompt = "Du bist ein erfahrener und motivierender Vertriebscoach. Deine Antworten sind immer positiv, konstruktiv und auf den Punkt gebracht.";

            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API-Anfrage fehlgeschlagen mit Status: ${response.status}`);

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    dom.hinweisModalContent.innerHTML = candidate.content.parts[0].text;
                } else {
                    throw new Error("Unerwartete Antwortstruktur von der API.");
                }

            } catch (error) {
                console.error("Fehler bei der Gemini-API-Anfrage:", error);
                dom.hinweisModalContent.textContent = "Der KI-Assistent ist im Moment leider nicht verfügbar. Bitte versuchen Sie es später erneut.";
            }
        }

        // --- User Data Editing Modal ---
        function openEditUserModal() {
            const user = loggedInUserData;
            document.getElementById('edit-name').value = user.Name || '';
            document.getElementById('edit-pwd').value = user.PWD || '';
            document.getElementById('edit-eh-quote').value = user.EHproATQuote || 0;

            const statusSelect = document.getElementById('edit-status');
            const positionSelect = document.getElementById('edit-position');
            clearChildren(statusSelect);
            clearChildren(positionSelect);

            const mitarbeiterMeta = METADATA.tables.find(t => t.name.toLowerCase() === 'mitarbeiter');
            const statusCol = mitarbeiterMeta.columns.find(c => c.key === COLUMN_MAPS.mitarbeiter.Status);
            
            statusCol.data.options.forEach(opt => {
                const optionEl = document.createElement('option');
                optionEl.value = opt.name;
                optionEl.textContent = opt.name;
                if (user.Status === opt.name) optionEl.selected = true;
                statusSelect.appendChild(optionEl);
            });

            db.karriereplan.forEach(plan => {
                const optionEl = document.createElement('option');
                optionEl.value = plan.Stufe;
                optionEl.textContent = plan.Stufe;
                if (user.Karrierestufe === plan.Stufe) optionEl.selected = true;
                positionSelect.appendChild(optionEl);
            });
            
            dom.editUserModal.classList.add('visible');
            document.body.classList.add('modal-open');
        }

        function closeEditUserModal() {
            dom.editUserModal.classList.remove('visible');
            document.body.classList.remove('modal-open');
        }
        
        async function saveUserData() {
            const user = loggedInUserData;
            const updatedRowData = {};

            updatedRowData[COLUMN_MAPS.mitarbeiter.Name] = document.getElementById('edit-name').value;
            updatedRowData[COLUMN_MAPS.mitarbeiter.PWD] = document.getElementById('edit-pwd').value;
            updatedRowData[COLUMN_MAPS.mitarbeiter.EHproATQuote] = parseFloat(document.getElementById('edit-eh-quote').value) || 0;
            updatedRowData[COLUMN_MAPS.mitarbeiter.Status] = document.getElementById('edit-status').value;
            
            const selectedPositionName = document.getElementById('edit-position').value;
            const selectedPositionRow = db.karriereplan.find(p => p.Stufe === selectedPositionName);
            if(selectedPositionRow) {
                 updatedRowData[COLUMN_MAPS.mitarbeiter.Karrierestufe] = [selectedPositionRow._id];
            }
            
            dom.saveUserBtn.textContent = "Speichern...";
            dom.saveUserBtn.disabled = true;

            const success = await seaTableUpdateRow('Mitarbeiter', user._id, updatedRowData);
            
            if (success) {
                closeEditUserModal();
                setStatus('Daten werden neu geladen...');
                await loadAllData(); 
                await fetchAndRenderDashboard(user._id);
            }

            dom.saveUserBtn.textContent = "Speichern";
            dom.saveUserBtn.disabled = false;
        }
        
        // --- START ---
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
