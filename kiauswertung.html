<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Vertrag-Extractor</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#60a5fa; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
.wrap{max-width:1100px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:16px;margin:12px 0}
button{background:var(--accent);border:none;color:#0b1220;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
textarea{width:100%;min-height:200px;background:#0b1220;color:#e5e7eb;border:1px solid #1f2937;border-radius:8px;padding:10px;resize:vertical}
.log{max-height:180px;overflow:auto;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:8px;font-size:.9rem}
.progress{height:8px;background:#0b1220;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
.bar{height:100%;width:0%;background:var(--accent);transition:width .25s}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace}
.muted{color:#94a3b8}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
</head>

<body>
<div class="wrap">
  <h1>Vertrag-Extractor <span class="muted">mit DSGVO</span></h1>

  <div class="card">
    <label>PDF-Datei hochladen:</label>
    <input id="file" type="file" accept=".pdf" style="width:100%;padding:8px;border:1px dashed #334155;background:#0b1220;color:#cbd5e1;border-radius:8px" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="anonBtn" disabled>Anonymisieren</button>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div id="phase" class="muted" style="text-align:right;margin-top:6px">Bereit</div>
  </div>

  <div class="card">
    <h3>Anonymisierter Text</h3>
    <textarea id="raw" class="mono" placeholder="Nach dem ersten Schritt erscheint hier der bereinigte Text …"></textarea>
  </div>

  <div class="card"><h3>Protokoll</h3><div id="log" class="log mono"></div></div>
</div>

<script>
const fileEl=document.getElementById("file"),
      anonBtn=document.getElementById("anonBtn"),
      rawEl=document.getElementById("raw"),
      barEl=document.getElementById("bar"),
      phaseEl=document.getElementById("phase"),
      logEl=document.getElementById("log");

let currentFile=null, anonymizedText="";

function log(m,c){const d=document.createElement("div");d.textContent=m;if(c)d.classList.add(c);logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;}
function bar(p){barEl.style.width=Math.max(0,Math.min(100,p))+"%";}
function phase(t){phaseEl.textContent=t;}

fileEl.addEventListener("change",()=>{
  currentFile=fileEl.files?.[0]??null;
  anonBtn.disabled=!currentFile;
  log("Datei gewählt: "+(currentFile?.name||"–"),"ok");
});

/* --- PDF lesen --- */
async function extractFromPDF(file){
  const buf=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  let text="";
  for(let i=1;i<=pdf.numPages;i++){
    const pg=await pdf.getPage(i);
    const tc=await pg.getTextContent();
    text+=tc.items.map(it=>it.str).join(" ")+"\n";
    bar((i/pdf.numPages)*50);
  }
  return text;
}

/* --- DSGVO-Anonymisierung --- */
function anonymizeSensitiveData(text){
  const financialKeywords=["rückkaufs","rueckkaufs","wert","kosten","prämie","praemie","beitrag","betrag","laufzeit","versicherungssumme","ablaufleistung","einzahlung","prämien"];
  const telContextRegex=/\b(tel|telefon|telefonnummer|handy|mobile|kontakt|fax|nr\.?|nummer)\b/i;
  let replaced=0;

  const labelMasks=[
    {
      regex:/(Versicherungsnehmer[_\s]*(?:in)?(?:\s*\(Name,\s*Geb\.?\.?\s*Dat\.?\))?)\s*:\s*([^,\n]+?)(?:,\s*(\d{1,2}\.\d{1,2}\.\d{2,4}))?(?=\s|$)/gi,
      replacer:(_match,label,_name,date)=>`${label}: [NAME]${date ? ", [DATUM]" : ""}`
    },
    {
      regex:/(Versicherte\s+Person|Versicherungsnehmer|Versicherungsnehmerin|Name|Kunde|Kundin|VN)\s*:\s*([A-ZÄÖÜ][a-zäöüß]+(?:\s+[A-ZÄÖÜ][a-zäöüß]+)+)/gi,
      replacer:(_match,label)=>`${label}: [NAME]`
    }
  ];

  for(const {regex,replacer} of labelMasks){
    text=text.replace(regex,(...args)=>{
      const match=args[0];
      const result=replacer(...args);
      if(result!==match) replaced++;
      return result;
    });
  }

  function hasFinancialContext(fullText,start,end){
    const windowStart=Math.max(0,start-40);
    const windowEnd=Math.min(fullText.length,end+40);
    const snippet=fullText.slice(windowStart,windowEnd).toLowerCase();
    if(snippet.includes("€")||snippet.includes("eur")) return true;
    return financialKeywords.some(keyword=>snippet.includes(keyword));
  }

  function shouldMaskTel(match,start,fullText){
    const end=start+match.length;
    if(hasFinancialContext(fullText,start,end)) return false;
    const digits=match.replace(/\D/g,"");
    if(digits.length<7) return false;

    const trimmed=match.trim();
    const dateLike=/^\d{1,2}[.\-/]\d{1,2}[.\-/]\d{2,4}$/;
    if(dateLike.test(trimmed)) return false;

    const dateContextRegex=/beginn|start|laufzeit|vertrags|polizzierungs|gueltig/i;
    const contextSnippet=fullText.slice(Math.max(0,start-30),Math.min(fullText.length,end+30));
    if(dateContextRegex.test(contextSnippet)) return false;

    const left=fullText.slice(Math.max(0,start-20),start).toLowerCase();
    const right=fullText.slice(end,Math.min(fullText.length,end+20)).toLowerCase();
    if(telContextRegex.test(left) || telContextRegex.test(right)) return true;

    const hasSeparator=/[\/\- ]/.test(trimmed);
    const startsWithDial=trimmed.startsWith("+")||trimmed.startsWith("0");
    if(startsWithDial && (hasSeparator || digits.length>=10)) return true;

    return false;
  }

  const patterns=[
    {re:/\b(Herrn?|Frau)\s+[A-ZÄÖÜ][a-zäöüß]+(?:\s+[A-ZÄÖÜ][a-zäöüß]+)+/g,ph:"[NAME]"},
    {re:/\b[A-Z]{2}\d{2}(?:\s?\d{4}){3,5}\b/g,ph:"[IBAN]"},
    {re:/\bBIC\s+[A-Z0-9]{8,11}\b/gi,ph:"[BIC]"},
    {re:/\+?\d[\d\s\/\-]{5,}\d/g,ph:"[TEL]",validator:shouldMaskTel},
    {re:/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi,ph:"[EMAIL]"},
  ];
  for(const {re,ph,validator} of patterns){
    text=text.replace(re,(match,offset,fullText)=>{
      if(validator && !validator(match,offset,fullText)) return match;
      replaced++;
      return ph;
    });
  }
  const birthDateRegex=/(Geburtsdatum|Geb\.|geboren am)[^0-9]{0,20}(\d{1,2}\.\d{1,2}\.\d{2,4})/gi;
  text=text.replace(birthDateRegex,(m,p1)=>{
    replaced++;
    return `${p1} [DATUM]`;
  });
  return {clean:text,count:replaced};
}

/* --- Schritt 1: Anonymisieren --- */
anonBtn.addEventListener("click",async()=>{
  if(!currentFile) return;
  phase("Lese PDF …"); bar(5);
  const text=await extractFromPDF(currentFile);
  const {clean,count}=anonymizeSensitiveData(text);
  anonymizedText=clean; rawEl.value=clean;
  log(`Anonymisierung abgeschlossen (${count} Elemente ersetzt).`,"ok");
  bar(100); phase("Fertig");
});
</script>
</body>
</html>
