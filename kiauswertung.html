<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Vertrag-Extractor + Gemini 2.5 Flash</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#60a5fa; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
.wrap{max-width:1100px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:16px;margin:12px 0}
button{background:var(--accent);border:none;color:#0b1220;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
textarea{width:100%;min-height:200px;background:#0b1220;color:#e5e7eb;border:1px solid #1f2937;border-radius:8px;padding:10px;resize:vertical}
.log{max-height:180px;overflow:auto;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:8px;font-size:.9rem}
.progress{height:8px;background:#0b1220;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
.bar{height:100%;width:0%;background:var(--accent);transition:width .25s}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace}
.muted{color:#94a3b8}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
</head>

<body>
<div class="wrap">
  <h1>Vertrag-Extractor <span class="muted">mit DSGVO + Gemini 2.5 Flash</span></h1>

  <div class="card">
    <label>PDF-Datei hochladen:</label>
    <input id="file" type="file" accept=".pdf" style="width:100%;padding:8px;border:1px dashed #334155;background:#0b1220;color:#cbd5e1;border-radius:8px" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="anonBtn" disabled>Anonymisieren</button>
      <button id="aiBtn" disabled>An Gemini 2.5 Flash senden</button>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div id="phase" class="muted" style="text-align:right;margin-top:6px">Bereit</div>
  </div>

  <div class="card">
    <h3>Anonymisierter Text</h3>
    <textarea id="raw" class="mono" placeholder="Nach dem ersten Schritt erscheint hier der bereinigte Text â€¦"></textarea>
  </div>

  <div class="card">
    <h3>Gemini-Ergebnis</h3>
    <pre id="result" class="mono"></pre>
  </div>

  <div class="card"><h3>Protokoll</h3><div id="log" class="log mono"></div></div>
</div>

<script>
const apiKey = "AIzaSyAUnqTaKJ1B7mvltFTWvHcz4szfA1YDFek";
const model = "gemini-2.5-flash";

const fileEl=document.getElementById("file"),
      anonBtn=document.getElementById("anonBtn"),
      aiBtn=document.getElementById("aiBtn"),
      rawEl=document.getElementById("raw"),
      resultEl=document.getElementById("result"),
      barEl=document.getElementById("bar"),
      phaseEl=document.getElementById("phase"),
      logEl=document.getElementById("log");

let currentFile=null, anonymizedText="";

function log(m,c){const d=document.createElement("div");d.textContent=m;if(c)d.classList.add(c);logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;}
function bar(p){barEl.style.width=Math.max(0,Math.min(100,p))+"%";}
function phase(t){phaseEl.textContent=t;}

fileEl.addEventListener("change",()=>{
  currentFile=fileEl.files?.[0]??null;
  anonBtn.disabled=!currentFile;
  log("Datei gewÃ¤hlt: "+(currentFile?.name||"â€“"),"ok");
});

/* --- PDF lesen --- */
async function extractFromPDF(file){
  const buf=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  let text="";
  for(let i=1;i<=pdf.numPages;i++){
    const pg=await pdf.getPage(i);
    const tc=await pg.getTextContent();
    text+=tc.items.map(it=>it.str).join(" ")+"\n";
    bar((i/pdf.numPages)*50);
  }
  return text;
}

/* --- DSGVO-Anonymisierung --- */
function anonymizeSensitiveData(text){
  const financialKeywords=["rÃ¼ckkaufs","rueckkaufs","wert","kosten","prÃ¤mie","praemie","beitrag","betrag","laufzeit","versicherungssumme","ablaufleistung","einzahlung","prÃ¤mien"];
  const telContextRegex=/\b(tel|telefon|telefonnummer|handy|mobile|kontakt|fax|nr\.?|nummer)\b/i;
  let replaced=0;

  const labelMasks=[
    {
      regex:/(Versicherungsnehmer[_\s]*(?:in)?(?:\s*\(Name,\s*Geb\.?\.?\s*Dat\.?\))?)\s*:\s*([^,\n]+?)(?:,\s*(\d{1,2}\.\d{1,2}\.\d{2,4}))?(?=\s|$)/gi,
      replacer:(_match,label,_name,date)=>`${label}: [NAME]${date ? ", [DATUM]" : ""}`
    },
    {
      regex:/(Versicherte\s+Person|Versicherungsnehmer|Versicherungsnehmerin|Name|Kunde|Kundin|VN)\s*:\s*([A-ZÃ„Ã–Ãœ][a-zÃ¤Ã¶Ã¼ÃŸ]+(?:\s+[A-ZÃ„Ã–Ãœ][a-zÃ¤Ã¶Ã¼ÃŸ]+)+)/gi,
      replacer:(_match,label)=>`${label}: [NAME]`
    }
  ];

  for(const {regex,replacer} of labelMasks){
    text=text.replace(regex,(...args)=>{
      const match=args[0];
      const result=replacer(...args);
      if(result!==match) replaced++;
      return result;
    });
  }

  function hasFinancialContext(fullText,start,end){
    const windowStart=Math.max(0,start-40);
    const windowEnd=Math.min(fullText.length,end+40);
    const snippet=fullText.slice(windowStart,windowEnd).toLowerCase();
    if(snippet.includes("â‚¬")||snippet.includes("eur")) return true;
    return financialKeywords.some(keyword=>snippet.includes(keyword));
  }

  function shouldMaskTel(match,start,fullText){
    const end=start+match.length;
    if(hasFinancialContext(fullText,start,end)) return false;
    const digits=match.replace(/\D/g,"");
    if(digits.length<7) return false;

    const trimmed=match.trim();
    const dateLike=/^\d{1,2}[.\-/]\d{1,2}[.\-/]\d{2,4}$/;
    if(dateLike.test(trimmed)) return false;

    const dateContextRegex=/beginn|start|laufzeit|vertrags|polizzierungs|gueltig/i;
    const contextSnippet=fullText.slice(Math.max(0,start-30),Math.min(fullText.length,end+30));
    if(dateContextRegex.test(contextSnippet)) return false;

    const left=fullText.slice(Math.max(0,start-20),start).toLowerCase();
    const right=fullText.slice(end,Math.min(fullText.length,end+20)).toLowerCase();
    if(telContextRegex.test(left) || telContextRegex.test(right)) return true;

    const hasSeparator=/[\/\- ]/.test(trimmed);
    const startsWithDial=trimmed.startsWith("+")||trimmed.startsWith("0");
    if(startsWithDial && (hasSeparator || digits.length>=10)) return true;

    return false;
  }

  const patterns=[
    {re:/\b(Herrn?|Frau)\s+[A-ZÃ„Ã–Ãœ][a-zÃ¤Ã¶Ã¼ÃŸ]+(?:\s+[A-ZÃ„Ã–Ãœ][a-zÃ¤Ã¶Ã¼ÃŸ]+)+/g,ph:"[NAME]"},
    {re:/\b[A-Z]{2}\d{2}(?:\s?\d{4}){3,5}\b/g,ph:"[IBAN]"},
    {re:/\bBIC\s+[A-Z0-9]{8,11}\b/gi,ph:"[BIC]"},
    {re:/\+?\d[\d\s\/\-]{5,}\d/g,ph:"[TEL]",validator:shouldMaskTel},
    {re:/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi,ph:"[EMAIL]"},
  ];
  for(const {re,ph,validator} of patterns){
    text=text.replace(re,(match,offset,fullText)=>{
      if(validator && !validator(match,offset,fullText)) return match;
      replaced++;
      return ph;
    });
  }
  const birthDateRegex=/(Geburtsdatum|Geb\.|geboren am)[^0-9]{0,20}(\d{1,2}\.\d{1,2}\.\d{2,4})/gi;
  text=text.replace(birthDateRegex,(m,p1)=>{
    replaced++;
    return `${p1} [DATUM]`;
  });
  return {clean:text,count:replaced};
}

/* --- Schritt 1: Anonymisieren --- */
anonBtn.addEventListener("click",async()=>{
  if(!currentFile) return;
  phase("Lese PDF â€¦"); bar(5);
  const text=await extractFromPDF(currentFile);
  const {clean,count}=anonymizeSensitiveData(text);
  anonymizedText=clean; rawEl.value=clean;
  log(`Anonymisierung abgeschlossen (${count} Elemente ersetzt).`,"ok");
  bar(100); phase("Bereit fÃ¼r Gemini"); aiBtn.disabled=false;
});

/* --- Schritt 2: Analyse mit Gemini 2.5 Flash --- */
aiBtn.addEventListener("click", async ()=>{
  if(!anonymizedText){alert("Bitte zuerst anonymisieren!");return;}

  phase("Sende an Gemini 2.5 Flash â€¦"); bar(30);
  const prompt=`ðŸ¤– Prompt â€“ Versicherungsagent-KI zur Vertragsanalyse (Ã–sterreich)
Du bist eine spezialisierte Versicherungsagent-KI mit umfassender Expertise im Ã¶sterreichischen Versicherungsmarkt.
Deine Aufgabe ist es, anonymisierte VersicherungsvertrÃ¤ge inhaltlich zu verstehen, alle relevanten Werte aufzuspÃ¼ren, zu kombinieren oder logisch herzuleiten, und sie prÃ¤zise in JSON-Struktur auszugeben.
Du arbeitest wie ein erfahrener Versicherungsberater, der komplexe VertrÃ¤ge liest, interpretiert und bewertet.

ðŸ§­ Arbeitsweise
Ganzheitliche Analyse:
- Lies das gesamte Dokument (Deckblatt, Tabellen, FuÃŸnoten, AnhÃ¤nge, Produktbeilagen, Fondsinformationen).
- Verstehe die Struktur und erkenne die Bedeutung jedes Abschnitts.

Versicherungslogik anwenden:
- Nutze dein Wissen Ã¼ber Versicherungsprodukte (Lebens-, Unfall-, Haushalts-, Eigenheim-, Rechtsschutzversicherung).
- Wenn Werte nicht klar angegeben sind, leite sie aus Kontext, Berechnungen oder Produkterfahrung ab.
- Beispiel: Wenn nur die monatliche PrÃ¤mie und Laufzeit angegeben sind, berechne die Gesamteinzahlung. Wenn kein Vertragsende steht, rechne es aus dem Beginn + Laufzeit. Wenn Fonds genannt sind, erkenne sie auch in Tabellen oder Fondslisten.

Synonyme und Formulierungen erkennen:
- Beachte unterschiedliche Bezeichnungen, z.B. PrÃ¤mie = Beitrag, laufende Zahlung, VersicherungsprÃ¤mie; Vertragsbeginn = Beginn, Start, Polizzierungsdatum; Laufzeit = Dauer, Versicherungsdauer; KÃ¼ndigung = Storno, VertragsauflÃ¶sung, RÃ¼cktritt.

Tiefensuche & logische Ableitung:
- Untersuche jedes Dokumentsegment, jede Tabelle und jeden Anhang.
- Suche nach Zahlen, Datumsangaben, Prozenten, EurobetrÃ¤gen und Beschreibungen.
- Rekonstruiere fehlende Werte, wenn sie rechnerisch oder durch Produktlogik eindeutig ableitbar sind.
- Wenn ein Wert selbst nach grÃ¼ndlicher Analyse nicht vorhanden oder rekonstruierbar ist, verwende "NICHT IM VERTRAG ENTHALTEN".

PlausibilitÃ¤tsprÃ¼fung:
- PrÃ¼fe WidersprÃ¼che zwischen Text und Tabellen.
- Berechne einfache Kennzahlen (z. B. Kostenquote = RÃ¼ckkaufswert Ã· Summe Einzahlungen Ã— 100).
- Gib immer die fachlich plausibelste Version aus.

ðŸ“‹ Analyseauftrag
1. Produkttyp
   Ordne den Vertrag genau einem dieser Typen zu:
   lebensversicherung, unfallversicherung, haushaltsversicherung, eigenheimversicherung, rechtschutzversicherung.

2. Grunddaten
   Ermittle: "vertragsbeginn" (YYYY-MM-DD, falls rekonstruierbar), "laufzeit" (in Jahren oder Monaten), "vertragsende" (direkt oder berechnet), "praemie" (Betrag + Zahlungsintervall, z. B. "150 â‚¬/Monat").

3. KÃ¼ndigung
   Gib die vertraglich festgelegte ordentliche KÃ¼ndigung wieder (Frist, Zeitpunkt, Form). Keine allgemeinen Gesetzesangaben â€“ nur, was im Vertrag oder den Bedingungen steht.

4. Produktspezifische Details
   Verwende genau den passenden Block unter "details":
   â€¢ Lebensversicherung
     "lebensversicherung": {
       "fondsveranlagungen": [],
       "rueckkaufswertZumEnde": {
         "0_prozent": "",
         "3_prozent": "",
         "6_prozent": ""
       },
       "kostenquoteProzent": ""
     }
   â€¢ Unfallversicherung
     "unfallversicherung": {
       "unfallkosten": "",
       "dauerndeInvaliditaet": "",
       "progressionProzent": "",
       "unfallrente": "",
       "spitalgeld": "",
       "krankengeld": ""
     }
   â€¢ Haushaltsversicherung
     "haushaltsversicherung": {
       "wohnnutzflaecheQm": "",
       "versicherungssummen": {},
       "grobeFahrlaessigkeit100Prozent": ""
     }
   â€¢ Eigenheimversicherung
     "eigenheimversicherung": {
       "wohnnutzflaecheQm": "",
       "verbauteFlaecheQm": "",
       "anzahlStockwerke": "",
       "versicherungssummen": {},
       "grobeFahrlaessigkeit100Prozent": ""
     }
   â€¢ Rechtsschutzversicherung
     "rechtschutzversicherung": {
       "versicherteBereiche": [],
       "deckungssummen": {}
     }

âš™ï¸ Ausgaberegeln
- Gib nur ein gÃ¼ltiges JSON-Objekt aus, ohne zusÃ¤tzlichen Text.
- Kein Feld darf leer bleiben.
- Wenn ein Wert nach grÃ¼ndlicher Dokument- und Kontextanalyse nicht eindeutig ermittelt werden kann, verwende den Text "NICHT IM VERTRAG ENTHALTEN".
- FÃ¼ge zusÃ¤tzlich "missingFields" hinzu â€“ ein Array mit allen Feldern, die du nicht belegen konntest.

ðŸ“¤ EndgÃ¼ltiges JSON-Schema
{
  "produktTyp": "",
  "vertragsbeginn": "",
  "laufzeit": "",
  "vertragsende": "",
  "praemie": "",
  "kuendigung": "",
  "details": {},
  "missingFields": []
}

ðŸ’¡ Fachliche Zusatzlogik
- Wenn mehrere Produkte vorkommen, analysiere nur das Hauptprodukt (z. B. Lebensversicherung bei Kombiprodukten).
- BerÃ¼cksichtige Fondsnamen, Tarife, Risikoklassen, Zusatzbausteine etc.
- Verwende ausschlieÃŸlich vertragliche Werte â€“ keine Beispielrechnungen.
- PrÃ¼fe interne Konsistenz zwischen PrÃ¤mie, Laufzeit und Werten.
- Am Ende muss jedes Pflichtfeld einen konkreten Wert oder "NICHT IM VERTRAG ENTHALTEN" haben.

Textauszug:
${(() => {
  const MAX_CHARS = 40000;
  return anonymizedText.length > MAX_CHARS
    ? anonymizedText.slice(0, MAX_CHARS) + "\n[Text gekÃ¼rzt]"
    : anonymizedText;
})()}
`;

  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
      {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          contents:[{ role:"user", parts:[{ text:prompt }] }],
        }),
      }
    );
    const data=await res.json();
    console.log("ðŸ” RAW RESPONSE:",data);
    if(data.error){
      resultEl.textContent="âŒ Fehler: "+data.error.message;
      log(data.error.message,"err"); phase("Fehler"); return;
    }
    let output="";
    if(data?.candidates?.[0]?.content?.parts){
      output=data.candidates[0].content.parts.map(p=>p.text||JSON.stringify(p)).join("\n");
    }
    resultEl.textContent=output||"(Keine Antwort)";
    phase("Fertig"); bar(100); log("Antwort empfangen.","ok");
  } catch(e){
    log("Fehler: "+e.message,"err"); phase("Fehler");
  }
});
</script>
</body>
</html>
